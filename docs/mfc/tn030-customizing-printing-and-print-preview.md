---
title: 'TN030: Настройка печати и предварительного просмотра | Документы Microsoft'
ms.custom: ''
ms.date: 06/28/2018
ms.technology:
- cpp-mfc
ms.topic: conceptual
f1_keywords:
- vc.print
dev_langs:
- C++
helpviewer_keywords:
- TN030
- customizing printing and print preview
- printing [MFC], views
- printing views [MFC]
- print preview [MFC], customizing
ms.assetid: 32744697-c91c-41b6-9a12-b8ec01e0d438
author: mikeblome
ms.author: mblome
ms.workload:
- cplusplus
ms.openlocfilehash: f67feaf03907cab836d83f4c6116ba1b2cbf32e7
ms.sourcegitcommit: 208d445fd7ea202de1d372d3f468e784e77bd666
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/29/2018
ms.locfileid: "37121067"
---
# <a name="tn030-customizing-printing-and-print-preview"></a>TN030. Настройка печати и предварительного просмотра

> [!NOTE]
> Следующее техническое примечание не было обновлено, поскольку сначала оно было включено в электронную документацию. В результате некоторые процедуры и разделы могут быть устаревшими или неверными. Для получения последних сведений рекомендуется выполнить поиск интересующей темы в алфавитном указателе документации в Интернете.

Эта заметка описывает процесс настройки печати и предварительного просмотра и в рамках процедуры обратного вызова, используемые в `CView` и обратный вызов процедуры и функции-члены `CPreviewView`.

## <a name="the-problem"></a>Проблема

MFC предоставляет комплексное решение для большинства печати и предварительного просмотра печати должен. В большинстве случаев немного дополнительного кода может иметь вид, возможность печати и предварительного просмотра. Тем не менее существуют способы оптимизации печати, требует значительных усилий со стороны разработчика, и некоторым приложениям требуется добавление элементов пользовательского интерфейса в режиме предварительного просмотра печати.

## <a name="efficient-printing"></a>Эффективный печати

При печати в приложении MFC, с помощью стандартных методов, Windows направляет все вызовы интерфейса графических устройств (GDI) выходной метафайла в памяти. Если `EndPage` является вызове Windows играет метафайла один раз для каждого физического диапазона, принтер для печати одной страницы. Во время этой визуализации GDI регулярно запрашивает процедуры Abort, чтобы определить, если следует продолжить. Обычно процедуры прерывания разрешает сообщения могут обрабатываться так, что пользователь может отменить задание печати, используя диалоговое окно печати.

К сожалению это может замедлить процесс печати. Если печать в приложении должен быть быстрее, чем это можно сделать с помощью стандартного способа, необходимо реализовать вручную чередования.

## <a name="print-banding"></a>Печать полосы

Чтобы вручную с аппаратным контроллером, необходимо повторно реализовать цикл печати таким образом, что `OnPrint` вызывается несколько раз на каждой странице (один раз в составе пакета обновления). Цикл печати реализована в `OnFilePrint` функции в viewprnt.cpp. В вашей `CView`-производного класса, чтобы элемент карты сообщений для обработки команд печати вызывает функцию печати перегрузке этой функции. Копировать `OnFilePrint` подпрограммы и изменение цикла печати для реализации чередования. Вы, вероятно, будет также требуется передать чередования прямоугольник функций печати, можно оптимизировать рисования, в зависимости от области печати страницы.

Во-вторых, часто необходимо вызвать метод `QueryAbort` при рисовании аппаратного контроллера управления. В противном случае не будет вызываться процедура прервать и пользователь сможет отменить задание печати.

## <a name="print-preview-electronic-paper-with-user-interface"></a>Предварительный просмотр печати: Электронный документ с помощью пользовательского интерфейса

Предварительный просмотр, по сути, пытается преобразовать отображаемое в эмуляции принтера. По умолчанию клиентской области главного окна используется для отображения одного или двух страниц полностью в окне. Пользователь может увеличить область страницы, чтобы увидеть его более подробно. С дополнительной поддержкой может даже дать пользователю возможность редактировать документ в режиме предварительного просмотра.

## <a name="customizing-print-preview"></a>Настройка предварительного просмотра печати

Эта заметка обрабатывает только один из аспектов изменения предварительного: Добавление пользовательского интерфейса в режим предварительного просмотра. Возможны и другие изменения, но такие изменения выходят за рамки данного обсуждения.

## <a name="to-add-ui-to-the-preview-mode"></a>Чтобы добавить пользовательский Интерфейс в режиме предварительного просмотра

1. Производный класс представления `CPreviewView`.

2. Добавьте обработчики команд для пользовательского интерфейса аспектов, которые необходимы.

3. При добавлении для отображения визуальных аспектов переопределить `OnDraw` и выполнять документ после вызова `CPreviewView::OnDraw`.

## <a name="onfileprintpreview"></a>OnFilePrintPreview

Этот метод является обработчиком команды для предварительного просмотра печати. Его реализация по умолчанию является:

```cpp
void CView::OnFilePrintPreview()
{
    // In derived classes, implement special window handling here
    // Be sure to Unhook Frame Window close if hooked.

    // must not create this on the frame. Must outlive this function
    CPrintPreviewState* pState = new CPrintPreviewState;

    if (!DoPrintPreview(AFX_IDD_PREVIEW_TOOLBAR, this,
        RUNTIME_CLASS(CPreviewView), pState))
    {
        // In derived classes, reverse special window handling
        // here for Preview failure case

        TRACE0("Error: DoPrintPreview failed");
        AfxMessageBox(AFX_IDP_COMMAND_FAILURE);
        delete pState;  // preview failed to initialize, delete State now
    }
}
```

`DoPrintPreview` предстоит скрыть основной области приложения. Панели элементов управления, такие как строка состояния, могут храниться, указав их в состояния производительности ->*dwStates* член (это битовая маска и биты для отдельного элемента управления полосы определяются AFX_CONTROLBAR_MASK (AFX_IDW_MYBAR)). -> Окна состояния производительности*nIDMainPane* — это окно, будут автоматически скрыты и reshown. `DoPrintPreview` Затем создается строка кнопок для стандартный пользовательский Интерфейс предварительного просмотра. Если требуется обработка специальное окно, такую как скрыть или отобразить другие окна, которые следует выполнить перед `DoPrintPreview` вызывается.

По умолчанию по завершении предварительного возвращается панелей элементов управления в исходное состояние и на главной панели, чтобы видимым. Если требуется специальная обработка, это следует делать в переопределении `EndPrintPreview`. Если `DoPrintPreview` завершается ошибкой, также предоставляют специальной обработки.

DoPrintPreview вызывается с:

- Идентификатор ресурса шаблона диалогового окна для панели инструментов предварительного просмотра.

- Указатель на представление для выполнения в режиме предварительного просмотра печати.

- Класс среды выполнения класса Предварительный просмотр. Это динамически создается в DoPrintPreview.

- Указатель на CPrintPreviewState. Обратите внимание, что структура CPrintPreviewState (или производного структуры, если приложению требуется несколько состояний, сохраненных) необходимо *не* создаваться в кадре. DoPrintPreview немодальное и эта структура должна доживают до вызова EndPrintPreview.

  > [!NOTE]
  > Если для поддержки печати требуется отдельное представление или класс представления, указатель на этот объект должен передаваться как второй параметр.

## <a name="endprintpreview"></a>EndPrintPreview

Это называется завершение режим предварительного просмотра. Часто желательно, чтобы перейти на страницу в документе, который предыдущей в режиме предварительного просмотра. `EndPrintPreview` — шанс этого приложения. -> PInfo*m_nCurPage* член странице последний (крайний левый, если бы отображались две страницы), который указатель подсказку о том, где пользователь был его заинтересован на странице. Поскольку структуры представления приложения неизвестен в платформе, необходимо указать код, чтобы перейти к выбранной точке.

Следует выполнять большинство операций перед вызовом `CView::EndPrintPreview`. Этот вызов отменяет последствия `DoPrintPreview` и удаляет pView, основного контроллера домена и pInfo.

```cpp
// Any further cleanup should be done here.
CView::EndPrintPreview(pDC, pInfo, point, pView);
```

## <a name="cwinapponfileprintsetup"></a>CWinApp::OnFilePrintSetup

Это должен быть сопоставлен для пункта меню Параметры печати. В большинстве случаев не требуется переопределять реализацию.

## <a name="page-nomenclature"></a>Страница номенклатуру

Другая проблема состоит нумерацию страниц и порядок. Для простого текстового редактора типа приложений это просто проблема. Большинство систем предварительного предполагается каждой отпечатанной странице соответствует одной страницы в документе.

При попытках организовать обобщенный решения, существует, необходимо учесть следующее. Представьте себе CAD системы. У пользователя есть прорисовки, которая охватывает несколько листов размер E. E-размера (или меньше, масштабирование) как в случае простого нумерацию страниц будет выдаваться,. Но на лазерный принтер, печать 16 A размер страниц на листе, что предварительного учитывает «страница»

Как говорится в вводный абзац, предварительного просмотра перед печатью действует как принтер. Таким образом пользователь увидит, что бы выходить из определенного принтера, который выбран. Именно view, чтобы определить, какое изображение печатается на каждой странице.

Строка описания страницы в `CPrintInfo` структура обеспечивает отображение номера страницы для пользователя, если он может быть представлено как одно число на каждой странице средства (как в «Страница 1» или «страницы 1-2»). Эта строка используется в реализации по умолчанию `CPreviewView::OnDisplayPageNumber`. Если требуется другое отображаемое один может переопределить это виртуальная функция для предоставления, например, «Лист1 разделах A, B».

## <a name="see-also"></a>См. также

[Технические примечания по номеру](../mfc/technical-notes-by-number.md)  
[Технические примечания по категории](../mfc/technical-notes-by-category.md)  
