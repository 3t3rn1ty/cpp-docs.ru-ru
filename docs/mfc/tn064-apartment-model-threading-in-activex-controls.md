---
title: 'TN064: Модели подразделения потоков в элементах управления ActiveX | Документы Microsoft'
ms.custom: ''
ms.date: 11/04/2016
ms.technology:
- cpp-mfc
ms.topic: conceptual
f1_keywords:
- vc.controls.activex
dev_langs:
- C++
helpviewer_keywords:
- OLE controls [MFC], container support
- containers [MFC], multithreaded
- TN064 [MFC]
- multithread container [MFC]
- apartment model threading [MFC]
ms.assetid: b2ab4c88-6954-48e2-9a74-01d4a60df073
author: mikeblome
ms.author: mblome
ms.workload:
- cplusplus
ms.openlocfilehash: a706c927a7aacaf69091d6b448e00bd7938c265f
ms.sourcegitcommit: c6b095c5f3de7533fd535d679bfee0503e5a1d91
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/26/2018
ms.locfileid: "36950439"
---
# <a name="tn064-apartment-model-threading-in-activex-controls"></a>TN064. Потоки изолированной модели в элементах управления ActiveX
> [!NOTE]
>  Следующее техническое примечание не было обновлено, поскольку сначала оно было включено в электронную документацию. В результате некоторые процедуры и разделы могут быть устаревшими или неверными. Для получения последних сведений рекомендуется выполнить поиск интересующей темы в алфавитном указателе документации в Интернете.  
  
 Это техническое Примечание описывает Включение потоковой модели в элементе управления ActiveX. Обратите внимание, что потоки модели подразделения поддерживается только в Visual C++ версии 4.2 или более поздней версии.  
  
## <a name="what-is-apartment-model-threading"></a>Что такое потоковой модели  
 Потоковая модель — это подход к поддержке внедренные объекты, такие как элементы управления ActiveX, в приложении многопоточный контейнер. Несмотря на то, что приложение может иметь несколько потоков, каждый экземпляр внедренного объекта будет назначен подразделению один», «который будет выполняться только в одном потоке. Другими словами все вызовы в экземпляр элемента управления происходит в том же потоке.  
  
 Тем не менее можно назначить различных экземпляров того же типа элемента управления в различных подразделениях. Таким образом Если несколько экземпляров элемента управления используют любые данные в общий (например, статические или глобальных данных), доступ к этим данным общего потребуется под защитой объект синхронизации, например критической секции.  
  
 Полные подробные сведения о замкнутую модель потоков, см. в разделе [процессы и потоки](http://msdn.microsoft.com/library/windows/desktop/ms684841) в *справочнике программиста OLE*.  
  
## <a name="why-support-apartment-model-threading"></a>Почему поддерживает потоковой модели  
 Элементы управления, поддерживающие потоки модели подразделения можно использовать в многопоточных контейнера приложений, поддерживающих потоковой модели. Если не включить потоковой модели, будет ограничен приводится список контейнеров, в которых можно использовать элемент управления.  
  
 Включение потоковой модели является просто для большинства элементов управления, особенно в том случае, если они имеют почти или совсем не общих данных.  
  
## <a name="protecting-shared-data"></a>Защита общих данных  
 Если элемент управления использует общие данные, такие как статическая переменная-член, доступ к данные должны быть защищены с критическую секцию, чтобы предотвратить изменение данных в то же время более чем одним потоком. Настройка критической секции для этой цели, объявить переменную статического члена класса `CCriticalSection` в классе элемента управления. Используйте `Lock` и `Unlock` данную критическую секцию функции-члены объекта везде, где код обращается к общим данным.  
  
 Например, рассмотрим класс элементов управления, должен поддерживать строка, которая совместно используется всеми экземплярами. Эта строка может хранится в статической переменной-члена и защищен критической секции. Объявление класса элемента управления должен содержать следующее:  
  
```  
class CSampleCtrl : public COleControl  
{  
 ...  
    static CString _strShared;  
    static CCriticalSection _critSect;  
};  
```  
  
 Реализация класса будет содержать определения для этих переменных:  
  
```  
int CString CSampleCtrl::_strShared;  
CCriticalSection CSampleCtrl::_critSect;  
```  
  
 Доступ к `_strShared` статический член затем могут быть защищены с критической секции:  
  
```  
void CSampleCtrl::SomeMethod()  
{  
    _critSect.Lock();
if (_strShared.Empty())  
    _strShared = "<text>";  
    _critSect.Unlock();

 ...  
}  
```  
  
## <a name="registering-an-apartment-model-aware-control"></a>Регистрация подразделения поддержкой модели управления  
 Элементы управления, поддерживающие потоки подразделения модели должно быть указано эту возможность в реестре, добавив именованное значение «ThreadingModel» со значением «Подразделение» в их класс идентификатор запись реестра *идентификатор класса* \\ **InprocServer32** ключа. Чтобы вызвать этот ключ автоматически регистрируется для элемента управления, передайте *afxRegApartmentThreading* флага в параметре шестой `AfxOleRegisterControlClass`:  
  
```  
BOOL CSampleCtrl::CSampleCtrlFactory::UpdateRegistry(BOOL bRegister)  
{  
    if (bRegister)  
    return AfxOleRegisterControlClass(
    AfxGetInstanceHandle(), 
    m_clsid, 
    m_lpszProgID, 
    IDS_SAMPLE, 
    IDB_SAMPLE, 
    afxRegApartmentThreading, 
    _dwSampleOleMisc, 
    _tlid, 
    _wVerMajor, 
    _wVerMinor);

 else  
    return AfxOleUnregisterClass(m_clsid,
    m_lpszProgID);

}  
```  
  
 Если проект элемента управления было создано автоматически в Visual C++ 4.1 или более поздней версии, этот флаг, уже присутствовать в коде. Изменения не требуются для регистрации потоковую модель.  
  
 Если проект был создан с помощью более ранней версии, существующий код будет иметь логическое значение в качестве параметра шестой. Если необходимый параметр имеет значение TRUE, измените его на *afxRegInsertable | afxRegApartmentThreading*. Если необходимый параметр имеет значение FALSE, измените его на *afxRegApartmentThreading*.  
  
 Если элемент управления не соответствует правилам модели потоков, нельзя передавать *afxRegApartmentThreading* в этом параметре.  
  
## <a name="see-also"></a>См. также  
 [Технические примечания по номеру](../mfc/technical-notes-by-number.md)   
 [Технические примечания по категории](../mfc/technical-notes-by-category.md)

