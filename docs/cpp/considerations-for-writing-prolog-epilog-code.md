---
title: "Вопросы, связанные с написанием кода пролога и эпилога | Microsoft Docs"
ms.custom: ""
ms.date: "11/04/2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-cpp"
ms.tgt_pltfrm: ""
ms.topic: "language-reference"
dev_langs: 
  - "C++"
helpviewer_keywords: 
  - "__LOCAL_SIZE - константа"
  - "код эпилога"
  - "код пролога"
  - "макет кадра стека"
  - "стек, макет кадра стека"
ms.assetid: c7814de2-bb5c-4f5f-96d0-bcfd2ad3b182
caps.latest.revision: 8
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
caps.handback.revision: 8
---
# Вопросы, связанные с написанием кода пролога и эпилога
[!INCLUDE[vs2017banner](../assembler/inline/includes/vs2017banner.md)]

## Блок, относящийся только к системам Microsoft  
 Перед написанием собственных последовательностей кодов пролога и эпилога важно понимать, как размещается кадр стека.  Полезно также знать, как использовать символ **\_\_LOCAL\_SIZE**.  
  
##  <a name="_pluslang_c.2b2b_.stack_frame_layout"></a> Макет кадра стека  
 В данном примере показан стандартный код пролога, который может присутствовать в 32\-разрядной функции.  
  
```  
push        ebp                ; Save ebp  
mov         ebp, esp           ; Set stack frame pointer  
sub         esp, localbytes    ; Allocate space for locals  
push        <registers>        ; Save registers  
```  
  
 Переменная `localbytes` представляет число байтов, которые требуются в стеке для локальных переменных, а переменная `<registers>` — это заполнитель, представляющий список сохраняемых в стеке регистров.  После проталкивания регистров можно разместить в стеке все другие необходимые данные.  Ниже приведен соответствующий код эпилога.  
  
```  
pop         <registers>   ; Restore registers  
mov         esp, ebp      ; Restore stack pointer  
pop         ebp           ; Restore ebp  
ret                       ; Return from function  
```  
  
 Стек всегда расширяется в направлении вниз \(от старших адресов памяти к младшим\).  Указатель базы \(`ebp`\) указывает на помещенное в стек значение `ebp`.  Область локальных переменных начинается с адреса `ebp-4`.  Для доступа к локальным переменным необходимо вычислить смещение от `ebp` путем вычитания соответствующего значения из `ebp`.  
  
##  <a name="_pluslang___local_size"></a> \_\_LOCAL\_SIZE  
 Компилятор предоставляет символ \(**\_\_LOCAL\_SIZE**\) для использования во встроенном ассемблерном блоке кода пролога функции.  Этот символ служит для выделения пространства локальным переменным в кадре стека пользовательского кода пролога.  
  
 Значение константы **\_\_LOCAL\_SIZE** определяется компилятором.  Это значение представляет общее количество байтов всех определяемых пользователем локальных переменных и временных переменных, создаваемых компилятором.  Константу **\_\_LOCAL\_SIZE** можно использовать только в качестве непосредственного операнда; в выражении ее использовать невозможно.  Значение этого символа не следует изменять и переопределять.  Например:  
  
```  
mov        eax, __LOCAL_SIZE           ;Immediate operand--Okay  
mov        eax, [ebp - __LOCAL_SIZE]   ;Error  
```  
  
 В следующем примере функции с атрибутом naked, содержащей пользовательские последовательности пролога и эпилога, символ **\_\_LOCAL\_SIZE** используется в последовательности пролога.  
  
```  
// the__local_size_symbol.cpp  
// processor: x86  
__declspec ( naked ) int main() {  
   int i;  
   int j;  
  
   __asm {      /* prolog */  
      push   ebp  
      mov      ebp, esp  
      sub      esp, __LOCAL_SIZE  
      }  
  
   /* Function body */  
   __asm {   /* epilog */  
      mov      esp, ebp  
      pop      ebp  
      ret  
      }  
}  
```  
  
### Завершение блока, относящегося только к системам Microsoft  
  
## См. также  
 [Вызовы функций Naked](../Topic/Naked%20Function%20Calls.md)