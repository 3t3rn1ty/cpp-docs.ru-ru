---
title: "Проекты Visual C++ CMake | Документы Microsoft"
ms.custom: 
ms.date: 08/08/2017
ms.reviewer: 
ms.suite: 
ms.technology:
- cpp-ide
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- C++
helpviewer_keywords:
- CMake in Visual C++
ms.assetid: 444d50df-215e-4d31-933a-b41841f186f8
author: mikeblome
ms.author: mblome
manager: ghogen
ms.workload:
- cplusplus
ms.openlocfilehash: 8b9f00e511be43e5a6b77abae6394013e4e33a34
ms.sourcegitcommit: 2cca90d965f76ebf1d741ab901693a15d5b8a4df
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/24/2018
---
# <a name="cmake-projects-in-visual-c"></a>Проекты Visual C++ CMake

В этой статье предполагается, что вы знакомы с CMake средство кросс платформенных, открытым исходным кодом для определения процессы сборки, которые выполняются на нескольких платформах.

Пока недавно, пользователям Visual Studio может использовать CMake для создания файлов проекта MSBuild, которые интегрированной среды разработки впоследствии использованы для IntelliSense, просмотра и компиляции. Начиная с Visual Studio 2017 г., **набора средств Visual C++ для CMake** компонентом **открыть папку** функции для включения интегрированной среды разработки для использования CMake файлы проекта (например, CMakeLists.txt) в целях IntelliSense и обзора. При использовании Visual Studio генератор файла временного проекта создается и передается msbuild.exe, но никогда не загружена для IntelliSense или целей просмотра. 

**Visual Studio 2017 г. версия 15,3**: поддержка обеспечивается для Visual Studio и ниндзя генераторы.

**Visual Studio 2017 г. версия 15.4**: добавлена поддержка CMake в Linux. Дополнительные сведения см. в разделе [Настройка проекта Linux CMake](../linux/cmake-linux-project.md).

**Visual Studio 2017 г. версия 15,5**: добавлена поддержка для импорта существующего кэша CMake. Visual Studio автоматически извлекает настраиваемые переменные и создает файл CMakeSettings.json заполнены.


## <a name="installation"></a>Установка

**Набор средств Visual C++ для CMake** устанавливается по умолчанию как часть **разработки настольных приложений с помощью C++** рабочей нагрузки.

![CMake компонента в рабочей нагрузке C++ рабочего стола](media/cmake-install.png)
 
## <a name="ide-integration"></a>Интеграция IDE

При выборе **файл | Откройте | Папка** для открытия папки, содержащей файл CMakeLists.txt, выполняются следующие действия:

- Visual Studio добавляет **CMake** пункта меню в главное меню с командами для просмотра и редактирования сценариев CMake.
- **Обозреватель решений** отображает структуру папок и файлов.
- Visual Studio запускает CMake.exe и приводит к возникновению ошибки CMake кэша по умолчанию *конфигурации*, который является x86 отладки. Отображаются в командной строке CMake **окно вывода**, а также дополнительные выходные данные CMake.
- В фоновом режиме Visual Studio запускает для индексации исходных файлов для включения IntelliSense, просмотра информации, рефакторинг и т. д. При работе в Visual Studio отслеживает изменения в редакторе, а также на диске, чтобы синхронизировать его индекс с источниками.
 
Вы можете открыть папки, содержащие любое количество CMake проектов. Visual Studio обнаруживает и настраивает все файлы CMakeLists.txt «root» в рабочей области. CMake операций (Настройка, сборка, отладка) также C++ IntelliSense и просмотра доступны для всех проектов CMake в рабочей области.

![Проект CMake с нескольких корней](media/cmake-multiple-roots.png) 

## <a name="import-an-existing-cache"></a>Импорт существующего кэша

При импорте файла CMakeCache.txt, Visual Studio автоматически извлекает настраиваемые переменные и создает файл предварительно заполненных CMakeSettings.json на их основе. Исходный кэша не изменяется каким-либо образом и по-прежнему может использоваться из командной строки или с любое средство или IDE использовался для его создания. Вместе с корневой проекта CMakeLists.txt помещается новый файл CMakeSettings.json. Visual Studio создает новый файл параметров зависимости кэша. Не все элементы в кэше импортируется.  Свойства, такие как генератор и расположение компиляторов заменяются со значениями по умолчанию, которые доступны для работы с интегрированной среды разработки.

### <a name="to-import-an-existing-cache"></a>Импорт существующего кэша

1. В главном меню выберите **файл | Откройте | CMake**:

   ![Откройте CMake](media/cmake-file-open.png "файла, открытие, CMake") 

   Откроется окно **CMake импорта из кэша** мастера. 
   
2. Перейдите к файлу CMakeCache.txt, который требуется импортировать и нажмите кнопку **ОК**. **Импорт CMake проекта из кэша** откроется окно мастера:

   ![Импорт кэша CMake](media/cmake-import-wizard.png "открыть мастер импорта кэша CMake") 

   По завершении работы мастера вы увидите новый файл CMakeCache.txt в **обозревателе решений** рядом с CMakeLists.txt корневого файла в проекте.


## <a name="building-cmake-projects"></a>Построение проектов CMake

Чтобы построить проект CMake, существуют следующие варианты.

1. Выберите целевой объект в **отладки** раскрывающегося списка и нажмите клавишу **F5**, или нажмите кнопку **запуска** (с зеленым треугольником). Во-первых, сборка проекта выполняется автоматически так же, как решение Visual Studio.
1. Щелкните правой кнопкой мыши CMakeLists.txt и выберите **построения** в контекстном меню. Если имеется несколько целевых объектов в структуру папок, можно выбрать для построения всех или только один целевой, или
1. В главном меню выберите **сборки | Построение решения** (**F7** или **Ctrl + Shift + B**). Убедитесь, что целевой объект CMake уже выбран в **элемент запуска** раскрывающийся список в **Общие** инструментов.

![CMake построить команду меню](media/cmake-build-menu.png "Cmake построения команды меню") 

Вызывается при выборе генератор Visual Studio для активной конфигурации MSBuild.exe с `-m -v:minimal` аргументы. Для настройки процесса построения, в файле CMakeSettings.json можно указать дополнительные аргументы командной строки для передачи через системы построения `buildCommandArgs` свойство:

```json
"buildCommandArgs": "-m:8 -v:minimal -p:PreferredToolArchitecture=x64"
```

Как и следовало ожидать, результаты построения отображаются в **окно вывода** и **список ошибок**.
 
![Ошибки построения CMake](media/cmake-build-errors.png "CMake ошибки построения")

В папке с нескольких целевых объектов построения, вы можете **построения** товара **CMake** меню или **CMakeLists.txt** контекстное меню для указания цели какие CMake для сборки. Нажав клавишу **Ctrl + Shift + B** в CMake сборка проекта выполняется текущий активный документ.

## <a name="debug-the-project"></a>Отладка проекта

Для отладки проекта CMake, выберите требуемую конфигурацию и нажмите клавишу **F5**, или нажмите клавишу **запуска** на панели инструментов. Если **запуска** кнопка «Выбор элемента запуска» выберите стрелку раскрывающегося списка и выберите целевой объект, который требуется запустить. (В проекте CMake «текущий документ» параметр допустим только для CPP-файлы.) 

![Кнопка запуска CMake](media/cmake-run-button.png "кнопку запуска Cmake")


**Запуска** или **F5** команды Сначала постройте проект, если были внесены изменения с момента предыдущей сборки.

## <a name="configure-cmake-debugging-sessions"></a>Настройка CMake сеансов отладки

Все исполняемые CMake целевые объекты отображаются в **элемент запуска** раскрывающийся список в **Общие** инструментов. Чтобы запустить сеанс отладки, выберите один и запустить отладчик.

![Раскрывающийся список элемента запуска CMake](media/cmake-startup-item-dropdown.png "раскрывающегося элемента запуска CMake")


Можно также начать сеанс отладки из меню CMake.

Чтобы настроить параметры отладчика для любой исполняемый CMake цели проекта, щелкните правой кнопкой мыши файл CMakeLists.txt и выберите **отладки и параметры запуска**. При выборе целевой CMake в подменю создается файл с именем launch.vs.json. Этот файл, предварительно заполненный сведениями о выбранных целевых CMake и позволяет указать дополнительные параметры, такие как аргументы программы или тип отладчика. Для ссылки в файле CMakeSettings.json любую клавишу, перед его с «cmake.» в launch.vs.json. В примере показан простой launch.vs.json файл, запрашивающий в значение ключа «remoteCopySources» в файле CMakeSettings.json для текущей конфигурации:

```json
{
  "version": "0.2.1",
  "defaults": {},
  "configurations": [
   {
      "type": "default",
      "project": "CMakeLists.txt",
      "projectTarget": "CMakeHelloWorld.exe (Debug\\CMakeHelloWorld.exe)",
      "name": "CMakeHelloWorld.exe (Debug\\CMakeHelloWorld.exe)",
      "args": ["${cmake.remoteCopySources}"]
    }
  ]
}
```

Сразу после сохранения файла launch.vs.json запись создается в **элемент запуска** раскрывающийся список с новым именем. Путем редактирования файла launch.vs.json, можно создать как угодно по какой-либо целей CMake многие конфигурации отладки.

**Visual Studio 2017 г. версия 15.4**: Launch.vs.json поддерживает переменные, объявленные в CMakeSettings.json (см. ниже) и, применяются к выбранной конфигурации. Он также содержит раздел с именем «currentDir», который задает текущий каталог при запуске приложения:


```json
{
"type": "default",
"project": "CMakeLists.txt",
"projectTarget": "CMakeHelloWorld1.exe (C:\\Users\\satyan\\CMakeBuilds\\Test\\Debug\\CMakeHelloWorld1.exe)",
"name": "CMakeHelloWorld1.exe (C:\\Users\\satyan\\CMakeBuilds\\Test\\Debug\\CMakeHelloWorld1.exe)",
"currentDir": "${env.USERPROFILE}\\CMakeBuilds\\${workspaceHash}"
}
```

При запуске приложения, значение `currentDir` является нечто похожее на

```cmd
C:\Users\satyan\7f14809a-2626-873e-952e-cdf038211175\
```

## <a name="editing-cmakeliststxt-files"></a>Редактирование файлов CMakeLists.txt

Чтобы изменить файл CMakeLists.txt, щелкните правой кнопкой мыши файл в **обозревателе решений** и выберите **откройте**. При внесении изменений в файл строку состояния желтый появляется и сообщает о том, что IntelliSense будет обновлена и дает возможность отменить операцию обновления. Сведения о CMakeLists.txt см. в разделе [CMake документации](https://cmake.org/documentation/).

   ![Редактирование файлов CMakeLists.txt](media/cmake-cmakelists.png "CMakeLists.txt редактирование файлов")


Сразу после сохранения файла на этапе конфигурации автоматически запускается снова и показывает информацию в **вывода** окна. Ошибки и предупреждения отображаются в **список ошибок** или **вывода** окна. Дважды щелкните ошибку в **список ошибок** для перехода к строке с ошибкой в CMakeLists.txt.

   ![Ошибки в файлах CMakeLists.txt](media/cmake-cmakelists-error.png "CMakeLists.txt ошибок")

## <a name="cmake_settings"></a> Параметры CMake и настраиваемые конфигурации

По умолчанию Visual Studio предоставляет шесть CMake конфигурации по умолчанию («x86-отладка», «x86 выпуск», «x64-отладка», «x64-выпуск», «Linux отладка» и «Linux выпуск»). Эти конфигурации определяют, как вызывается CMake.exe создать CMake кэш для данного проекта. Чтобы изменить эти настройки или создания новой пользовательской конфигурации, выберите **CMake | Изменение параметров CMake**и выберите файл CMakeLists.txt, которому применяются параметры. **Изменение параметров CMake** команда также доступна в контекстном меню файла в **обозревателе решений**. Эта команда создает файл CMakeSettings.json в папке проекта. Этот файл используется для повторного создания файла кэша CMake, например после **Очистить** операции. 

   ![Команды главного меню CMake для изменения параметров](media/cmake-change-settings.png)


JSON IntelliSense помогает изменить файл CMakeSettings.json:

   ![CMake JSON IntelliSense](media/cmake-json-intellisense.png "CMake JSON IntelliSense")

Ниже приведен пример приведен пример конфигурации, который можно использовать в качестве отправной точки для создания собственных в CMakeSettings.json.

```json
    {
      "name": "x86-Debug",
      "generator": "Ninja",
      "configurationType": "Debug",
      "inheritEnvironments": [ "msvc_x86" ],
      "buildRoot": "${env.USERPROFILE}\\CMakeBuilds\\${workspaceHash}\\build\\${name}",
      "installRoot": "${env.USERPROFILE}\\CMakeBuilds\\${workspaceHash}\\install\\${name}",
      "cmakeCommandArgs": "",
      "buildCommandArgs": "-v",
      "ctestCommandArgs": ""
    },

```

1. **имя**: имя, которое отображается в раскрывающемся списке конфигурации C++. Значение этого свойства можно также использовать как макрос, `${name}`, чтобы задать другие значения свойства. Пример см. в разделе **buildRoot** определение в CMakeSettings.json.
1. **Генератор**: сопоставляется **- G** переключения и задает генератор для использования. Это свойство также может использоваться как макрос, `${generator}`, чтобы задать другие значения свойства. Visual Studio в настоящее время поддерживает следующие генераторы CMake:


    - «Ниндзя»
    - «Visual Studio 14 2015»
    - «Visual Studio 14 2015, ВХОДЯЩАЯ в
    - «Visual Studio 14 2015 Win64»
    - «Visual Studio 15 2017 г.»
    - «ARM visual Studio 15 2017 г.»
    - «Win64 visual Studio 15 2017 г.»

Поскольку ниндзя предназначена для быстрой сборки скорости вместо гибкость и функции, он устанавливается по умолчанию. Однако некоторые проекты CMake может быть не удалось правильно построить с помощью ниндзя. В этом случае можно указать CMake Создание проекта Visual Studio.

Чтобы указать генератор Visual Studio, откройте CMakeSettings.json в главном меню, выбрав **CMake | Изменение параметров CMake**. Удалите «Ниндзя» и введите «V». Это активирует IntelliSense, что позволяет выбрать нужный генератора.

1. **buildRoot**: сопоставляется **-DCMAKE_BINARY_DIR** переключения и указывает, где будут создаваться кэш CMake. Если папка не существует, он создается.
1. **переменные**: содержит пары имя значение CMake переменных, которые будут передаются как **-D**_имя_**=**_значение_ в CMake. Если инструкции построения проекта CMake указать добавления всех переменных непосредственно в файле кэша CMake, рекомендуется добавить их здесь вместо.
1. **cmakeCommandArgs**: указывает любые дополнительные параметры, необходимо передать CMake.exe.
1. **Тип конфигурации**: Определяет тип конфигурации сборки для выбранного генератора. В настоящее время поддерживаемые значения: «Debug», «MinSizeRel», «Выпуск» и «RelWithDebInfo».

### <a name="environment-variables"></a>Переменные среды

CMakeSettings.json также поддерживает много переменных среды в любые свойства, упомянутых выше. Синтаксис для использования `${env.FOO}` для расширения среды % переменная % FOO.
Также имеют доступ к встроенных макросов внутри данного файла:

- `${workspaceRoot}` — предоставляет полный путь папки рабочей области
- `${workspaceHash}` — хэш расположение рабочей области; полезно для создания уникального идентификатора для текущей рабочей области (например, для использования в пути папки)
- `${projectFile}` — Полный путь к корневому файлу CMakeLists.txt
- `${projectDir}` — Полный путь к папке CMakeLists.txt корневого файла
- `${thisFile}` — Полный путь к файлу CMakeSettings.json
- `${name}` — Имя конфигурации
- `${generator}` — имя генератора CMake, используемый в этой конфигурации

### <a name="ninja-command-line-arguments"></a>Аргументы командной строки ниндзя

Если целевые объекты не заданы, создает целевой объект «default» (см. руководство).

```cmd
C:\Program Files (x86)\Microsoft Visual Studio\Preview\Enterprise>ninja -?
ninja: invalid option -- `-?'
usage: ninja [options] [targets...]
```

|Параметр|Описание:|
|--------------|------------|
| — версия  | Печать версии ниндзя («1.7.1»)|
|   -C DIR   | изменить на DIR перед выполнением других действий|
|   f - файла  | Укажите файл входной сборки (default=build.ninja)|
|   -j N     | параллельное выполнение заданий N (по умолчанию = 14, производным от ЦП, доступных)|
|   -k N     | Продолжайте, пока N заданий завершились сбоем (по умолчанию = 1)|
|   -l N     | новые задания не запускаются, если среднее значение нагрузки больше, чем N|
|   -n      | Сухая запуска (не выполнять команды, но действовать так, как они успешно)|
|   -v       | Показать все командной строки во время построения|
|   -d режим  | Включите отладку (-d режимы одного списка)|
|   t - СРЕДСТВО  | Запустите subtool (среди одного списка используйте -t). Завершает параметры верхнего уровня; Дополнительные флаги переданы в средство| 
|   -w FLAG  | Настройка предупреждений (-w предупреждений списка в список)|

### <a name="inherited-environments-visual-studio-2017-version-155"></a>Наследуемые сред (Visual Studio 2017 г. версия 15,5)
CMakeSettings.json теперь поддерживает наследуемые сред. Эта функция позволяет (1) наследуют сред по умолчанию и (2) создайте пользовательские переменные, которые передаются CMake.exe при запуске.

```json
  "inheritEnvironments": [ "msvc_x64_x64" ]
```

В приведенном выше примере является таким же, как работает **Командная строка разработчика для VS 2017 г** с **-arch = amd64-host_arch = amd64** аргументы.

Следующая таблица показывает значения по умолчанию и их эквиваленты командной строки:

|Имя контекста|Описание:|
|-----------|-----------------|
|vsdev|Среда Visual Studio по умолчанию|
|msvc_x86|Компиляция с помощью x86 x86 средства|
|msvc_arm| Компилировать для архитектуры ARM с помощью x86 средств|
|msvc_arm64|Компилировать для ARM64 x86 с помощью средства|
|msvc_x86_x64|Компилировать для AMD64 x86 с помощью средства|
|msvc_x64_x64|Компилировать для AMD64, с помощью средств 64-разрядная версия|
|msvc_arm_x64|Компиляция с помощью 64-разрядные средства ARM|
|msvc_arm64_x64|Компилировать для ARM64 с помощью средств 64-разрядная версия|

### <a name="custom-environment-variables"></a>Пользовательские переменные.
В CMakeSettings.json, можно определить пользовательские переменные глобально или для каждой конфигурации в **среды** свойство. В следующем примере определяется одну глобальную переменную **BuildDir**, которая наследуется в конфигурациях отладки x86 и x64-Debug. Каждая конфигурация использует переменную для указания значения для **buildRoot** для этой конфигурации. Обратите внимание, как каждая конфигурация использует **inheritEnvironments** свойство, чтобы указать переменную, которая применяется только к этой конфигурации.

```json
{
  // The "environments" property is an array of key value pairs of the form
  // { "EnvVar1": "Value1", "EnvVar2": "Value2" }
  "environments": [
    {
      "BuildDir": "${env.USERPROFILE}\\CMakeBuilds\\${workspaceHash}\\build",
    }
  ],

  "configurations": [
    {
      "name": "x86-Debug",
      "generator": "Ninja",
      "configurationType": "Debug",
      // Inherit the defaults for using the MSVC x86 compiler.
      "inheritEnvironments": [ "msvc_x86" ],
      "buildRoot": "${env.BuildDir}\\${name}"    },
    {
      "name": "x64-Debug",
      "generator": "Ninja",
      "configurationType": "Debug",
      // Inherit the defaults for using the MSVC x64 compiler.
      "inheritEnvironments": [ "msvc_x64" ],
      "buildRoot": "${env.BuildDir}\\${name}"
    }
  ]
}
```

В следующем примере конфигурации отладки x86 определяет собственное значение для **BuildDir** свойство и это значение переопределяет значение, заданное в глобальном **BuildDir** свойство, чтобы  **BuildRoot** равен `D:\custom-builddir\x86-Debug`.

```json
{
  "environments": [
    {
      "BuildDir": "${env.USERPROFILE}\\CMakeBuilds\\${workspaceHash}",
    }
  ],

  "configurations": [
    {
      "name": "x86-Debug",

      // The syntax for this property is the same as the global one above.
      "environments": [
        {
          // Replace the global property entirely.
          "BuildDir": "D:\\custom-builddir",
        }
      ],

      "generator": "Ninja",
      "configurationType": "Debug",
      "inheritEnvironments": [ "msvc_x86" ],
      // Evaluates to "D:\custom-builddir\x86-Debug"
      "buildRoot": "${env.BuildDir}\\${name}"
    },
    {
      "name": "x64-Debug",

      "generator": "Ninja",
      "configurationType": "Debug",
      "inheritEnvironments": [ "msvc_x64" ], 
      // Since this configuration doesn’t modify BuildDir, it inherits
      // from the one defined globally.
      "buildRoot": "${env.BuildDir}\\${name}"
    }
  ]
}
```

## <a name="cmake-configure-step"></a>Шаг настройки CMake

При существенных изменений CMakeSettings.json или CMakeLists.txt файлы, Visual Studio автоматически повторно выполняет CMake настроить шаг. Если настройка шаг завершается без ошибок, собранных данных доступна в C++ IntelliSense и языковые службы и Кроме того, в построения и отладки операций.

Если несколько проектов CMake использовать то же имя таблицы конфигурации CMake (например, x86-Debug), все они настраиваются и встроенной (в корневой папке свои собственные сборки) при выборе этой конфигурации. Можно отлаживать целевых объектов из всех проектов CMake, участвующие в этой конфигурации CMake.

   ![CMake построить только элемент меню](media/cmake-build-only.png "CMake построить только пункта меню")

Чтобы ограничить сборки и отладки сеансы подмножество проектов в рабочей области, создать новую конфигурацию с уникальным именем в файле CMakeSettings.json и применит его только для этих проектов. При выборе этой конфигурации только для тех проектов, указанной включены команды IntelliSense и построения и отладки.

## <a name="troubleshooting-cmake-cache-errors"></a>Устранение неполадок кэша CMake

Если требуются дополнительные сведения о состоянии CMake кэша для диагностики проблемы, откройте **CMake** главного меню или **CMakeLists.txt** контекстного меню в **обозревателе решений**запустить одну из следующих команд:

- **Просмотр кэша** открывает файл CMakeCache.txt в корневой папке сборки в редакторе. (Любые изменения, внесенные здесь CMakeCache.txt были очищены если очистка кэша. Чтобы внести изменения, которые сохраняются после очистки кэша, в разделе [CMake параметры и настраиваемые конфигурации](#cmake_settings) ранее в этой статье.)
- **Откройте папку кэша** открывает окно проводника в корневой папке построения.  
- **Очистить кэш** удаляет корневой папке построения, чтобы далее CMake настроить шаг начинается с очистки кэша.
- **Создание кэша** принудительно создать шаг, чтобы выполнялось, даже если Visual Studio распознает актуальные среды.
