---
title: "Проекты Visual C++ CMake | Документы Microsoft"
ms.custom: 
ms.date: 08/08/2017
ms.reviewer: 
ms.suite: 
ms.technology: cpp-ide
ms.tgt_pltfrm: 
ms.topic: article
dev_langs: C++
helpviewer_keywords: CMake in Visual C++
ms.assetid: 444d50df-215e-4d31-933a-b41841f186f8
author: mikeblome
ms.author: mblome
manager: ghogen
ms.workload: cplusplus
ms.openlocfilehash: d38538ce929410782eee7a0a6540bb62a05b7669
ms.sourcegitcommit: 8fa8fdf0fbb4f57950f1e8f4f9b81b4d39ec7d7a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/21/2017
---
# <a name="cmake-projects-in-visual-c"></a>Проекты Visual C++ CMake
В этой статье предполагается, что вы знакомы с CMake средство кросс платформенных, открытым исходным кодом для определения процессы сборки, которые выполняются на нескольких платформах.  

Пока недавно, пользователям Visual Studio может использовать CMake для создания файлов проекта MSBuild, которые интегрированной среды разработки впоследствии использованы для IntelliSense, просмотра и компиляции. Начиная с Visual Studio 2017 г., **набора средств Visual C++ для CMake** компонент использует функцию «Открыть папку» Включение IDE, чтобы использовать файлы проекта CMake (например, CMakeLists.txt) непосредственно в целях IntelliSense и просмотра. При использовании Visual Studio генератор файла временного проекта создается и передается msbuild.exe, но никогда не загружена для IntelliSense или целей просмотра. 

**Visual Studio 2017 г. версия 15,3**: поддержка обеспечивается для Visual Studio и ниндзя генераторы.

**Visual Studio 2017 г. версия 15.4**: добавлена поддержка CMake в Linux. Дополнительные сведения см. в разделе [Настройка проекта Linux CMake](../linux/cmake-linux-project.md).

## <a name="installing"></a>Установка
Набор средств Visual C++ для CMake устанавливается по умолчанию как часть разработки настольных приложений C++ рабочей нагрузки.

![CMake компонента в рабочей нагрузке C++ рабочего стола](media/cmake-install.png)
 
## <a name="ide-integration"></a>Интеграция IDE
При выборе **файл | Откройте | Папка** для открытия папки, содержащей файл CMakeLists.txt, выполняются следующие действия:
- Visual Studio добавляет **CMake** пункта меню в главное меню с командами для просмотра и редактирования сценариев CMake. 
- **Обозреватель решений** отображает структуру папок и файлов. 
- Visual Studio запускает CMake.exe и приводит к возникновению ошибки CMake кэша по умолчанию *конфигурации*, который является x86 отладки. Отображаются в командной строке CMake **окно вывода**, а также дополнительные выходные данные CMake.
- В фоновом режиме Visual Studio запускает для индексации исходных файлов для включения IntelliSense, просмотра информации, рефакторинг и т. д. При работе в Visual Studio отслеживает изменения в редакторе, а также на диске, чтобы синхронизировать его индекс с источниками. Вы можете открыть папки, содержащие любое количество CMake проектов. Visual Studio обнаруживает и настраивает все файлы CMakeLists.txt «root» в рабочей области. CMake операций (Настройка, сборка, отладка) также C++ IntelliSense и просмотра доступны для всех проектов CMake в рабочей области.

![Проект CMake с нескольких корней](media/cmake-multiple-roots.png) 

## <a name="building-cmake-projects"></a>Построение проектов CMake
Чтобы построить проект CMake, существуют следующие варианты.
1. Выберите целевой объект в раскрывающемся списке отладки и нажмите клавишу **F5** или нажмите кнопку «Выполнить». Проект будет автоматически построения во-первых, так же, как с помощью решения Visual Studio.
2.  Щелкните правой кнопкой мыши CMakeLists.txt и выберите построение в контекстном меню. Если имеется несколько целевых объектов в структуру папок, можно выбрать для построения всех или только один целевой, или
  
3. В главном меню выберите **сборки | Построение решения** (**F7** или **Ctrl + Shift + B**) (Убедитесь, что целевой объект CMake уже выбран в **элемент запуска** раскрывающийся список в **Общие** инструментов).

![Команда меню построения CMake](media/cmake-build-menu.png) 
 
Вызывается при выборе генератор Visual Studio для активной конфигурации MSBuild.exe с `-m -v:minimal` аргументы. Для настройки процесса построения, в файле CMakeSettings.json можно указать дополнительные аргументы командной строки для передачи через системы построения `buildCommandArgs` свойство:

```json
"buildCommandArgs": "-m:8 -v:minimal -p:PreferredToolArchitecture=x64"
```
Как и следовало ожидать, результаты построения отображаются в **окно вывода** и **список ошибок**.
 
![Ошибки построения CMake](media/cmake-build-errors.png)

В папке с нескольких целевых объектов построения можно выбрать элемент в CMake меню или в контекстном меню CMakeLists.txt для указания цели какие CMake для построения сборки. Нажав клавишу **Ctrl + Shift + B** в CMake сборка проекта выполняется текущий активный документ. 

## <a name="debugging-the-project"></a>Отладка проекта
Для отладки проекта CMake, выберите требуемую конфигурацию и нажмите клавишу **F5**, или нажмите кнопку выполнить на панели инструментов. Если запуск кнопка «Выбор элемента запуска», нажмите кнопку со стрелкой вниз и выберите целевой объект, который требуется запустить. (В проекте CMake «текущий документ» параметр допустим только для CPP-файлы.) 

 ![Кнопка запуска CMake](media/cmake-run-button.png)

 Нажав клавишу **F5** будет первого построения проекта, если были внесены изменения с момента предыдущей сборки.

## <a name="configuring-cmake-debugging-sessions"></a>Настройка CMake сеансов отладки
В раскрывающемся списке элемент запуска на главной панели инструментов отображаются все целевые объекты CMake исполняемый файл. Чтобы запустить сеанс отладки, выберите один и запустить отладчик.

 ![Раскрывающийся список элемента запуска CMake](media/cmake-startup-item-dropdown.png)

Можно также начать сеанс отладки из меню CMake.

Чтобы настроить параметры отладчика для любой исполняемый CMake цели проекта, щелкните правой кнопкой мыши файл CMakeLists.txt и выберите **отладки и параметры запуска**, при выборе целевой CMake в подменю файл с именем создается Launch.VS.JSON. Этот файл, предварительно заполненный сведениями о выбранных целевых CMake и позволяет указать дополнительные параметры, такие как аргументы программы или тип отладчика. Для ссылки в файле CMakeSettings.json любую клавишу, перед его с «cmake.» в launch.vs.json. В примере показан простой launch.vs.json файл, запрашивающий в значение ключа «remoteCopySources» в файле CMakeSettings.json для текущей конфигурации:

```json
{
  "version": "0.2.1",
  "defaults": {},
  "configurations": [
   {
      "type": "default",
      "project": "CMakeLists.txt",
      "projectTarget": "CMakeHelloWorld.exe (Debug\\CMakeHelloWorld.exe)",
      "name": "CMakeHelloWorld.exe (Debug\\CMakeHelloWorld.exe)",
      "args": ["${cmake.remoteCopySources}"]
    }
  ]
}
```
Сразу после сохранения файла launch.vs.json запись создается в раскрывающемся списке элемент запуска с новым именем. Путем редактирования файла launch.vs.json, можно создать как угодно по какой-либо целей CMake многие конфигурации отладки.

**Visual Studio 2017 г. версия 15.4**: Launch.vs.json поддерживает переменные, объявленные в CMakeSettings.json (см. ниже). Он также имеет понятие «currentDir», который будет установлен в качестве текущего каталога при запуске приложения:

```json
{
"type": "default",
"project": "CMakeLists.txt",
"projectTarget": "CMakeHelloWorld1.exe (C:\\Users\\satyan\\CMakeBuilds\\Test\\Debug\\CMakeHelloWorld1.exe)",
"name": "CMakeHelloWorld1.exe (C:\\Users\\satyan\\CMakeBuilds\\Test\\Debug\\CMakeHelloWorld1.exe)",
"currentDir": "${env.USERPROFILE}\\CMakeBuilds\\${workspaceHash}"
}
```
При запуске приложения, значение `currentDir` является 

```cmd
C:\Users\satyan\7f14809a-2626-873e-952e-cdf038211175\
```
 

## <a name="editing-cmakeliststxt-files"></a>Редактирование файлов CMakeLists.txt
Чтобы изменить файл CMakeLists.txt, щелкните правой кнопкой мыши файл в **обозревателе решений** и выберите **откройте**. При внесении изменений в файл строку состояния желтый появляется и сообщает о том, что IntelliSense будет обновлена и дает возможность отменить операцию обновления. Сведения о CMakeLists.txt см. в разделе [CMake документации](https://cmake.org/documentation/).

  ![Редактирование файлов CMakeLists.txt](media/cmake-cmakelists.png)

Сразу после сохранения файла шаг настройки автоматически запустите еще раз и отображения информации в окне вывода. Ошибки и предупреждения отображаются в списке ошибок или окне вывода. Дважды щелкните ошибку в списке ошибок, чтобы перейти к строке с ошибкой в CMakeLists.txt.

  ![Ошибки в файлах CMakeLists.txt](media/cmake-cmakelists-error.png)
 
## <a name="cmake_settings"></a>Параметры CMake и настраиваемые конфигурации
По умолчанию Visual Studio предоставляет шесть CMake конфигурации по умолчанию («x86-отладка», «x86 выпуск», «x64-отладка», «x64-выпуск», «Linux отладка» и «Linux выпуск»). Эти конфигурации определяют, как вызывается CMake.exe создать CMake кэш для данного проекта. Чтобы изменить эти настройки или создания новой пользовательской конфигурации, выберите **CMake | Изменить параметр CMake**, а затем выберите файл CMakeLists.txt, параметры будут применяться к. Изменение параметров CMake также доступна в контекстном меню файла в **обозревателе решений**. Эта команда создает файл CMakeSettings.json в папке проекта. Этот файл используется для повторного создания файла кэша CMake, например после выполнения операции «Очистить». 

  ![Команды главного меню CMake для изменения параметров](media/cmake-change-settings.png)
 
JSON IntelliSense помогает изменить файл CMakeSettings.json:

   ![IntelliSense CMake JSON](media/cmake-json-intellisense.png)

Ниже приведен пример приведен пример конфигурации, который можно использовать в качестве отправной точки для создания собственных в CMakeSettings.json.
```json
    {
      "name": "x86-Debug",
      "generator": "Ninja",
      "configurationType": "Debug",
      "inheritEnvironments": [ "msvc_x86" ],
      "buildRoot": "${env.USERPROFILE}\\CMakeBuilds\\${workspaceHash}\\build\\${name}",
      "installRoot": "${env.USERPROFILE}\\CMakeBuilds\\${workspaceHash}\\install\\${name}",
      "cmakeCommandArgs": "",
      "buildCommandArgs": "-v",
      "ctestCommandArgs": ""
    },

```
1.  Имя: имя, которое будет отображаться в раскрывающемся списке конфигурации C++. Значение этого свойства можно также использовать как макрос `${name}` для указания значений других свойств. Пример см. в CMakeSettings.json определение «buildRoot».
2.  Генератор: сопоставляется с параметром -G и задает генератор для использования. Это свойство также может использоваться как макрос `${generator}` позволяют указывать другие значения свойства. Visual Studio в настоящее время поддерживает следующие генераторы CMake:
    - «Ниндзя»
    - «Visual Studio 14 2015»
    - «Visual Studio 14 2015, ВХОДЯЩАЯ в
    - «Visual Studio 14 2015 Win64»
    - «Visual Studio 15 2017 г.»
    - «ARM visual Studio 15 2017 г.»
    - «Win64 visual Studio 15 2017 г.»
    - 
Поскольку ниндзя предназначена для быстрой сборки скорости вместо гибкость и функции, он устанавливается по умолчанию. Однако некоторые проекты CMake может быть не удалось правильно построить с помощью ниндзя. В этом случае можно указать CMake Создание проекта Visual Studio. 

Чтобы указать генератор Visual Studio, откройте CMakeSettings.json в главном меню, выбрав **CMake | Изменение параметров CMake**. Удалите «Ниндзя» и введите «V». Это активирует IntelliSense, что позволяет выбрать нужный генератора.
3.  buildRoot: сопоставляется - DCMAKE_BINARY_DIR коммутатора и указывает, где будет создан кэш CMake. Если папка не существует, он будет создан.
4.  переменные: содержит пару имя + значение CMake переменных, которые будут передаются как - Dname = value в CMake. Если инструкции построения проекта CMake указать добавления всех переменных непосредственно в файл кэша CMake, рекомендуется добавить их здесь вместо.
5.  cmakeCommandArgs: указывает любые дополнительные параметры, необходимо передать CMake.exe.
6.  Тип конфигурации: Определяет тип конфигурации сборки для выбранного генератора. В настоящее время поддерживаемые значения: «Debug», «MinSizeRel», «Выпуск» и «RelWithDebInfo».

### <a name="environment-variables"></a>Переменные среды
CMakeSettings.json также поддерживает много переменных среды в любые свойства, упомянутых выше. Синтаксис для использования `${env.FOO}` для расширения среды % переменная % FOO.
Также имеют доступ к встроенных макросов внутри данного файла:
- `${workspaceRoot}`— предоставляет полный путь папки рабочей области
- `${workspaceHash}`— хэш расположение рабочей области; полезно для создания уникального идентификатора для текущей рабочей области (например, для использования в пути папки)
- `${projectFile}`— Полный путь к корневому файлу CMakeLists.txt
- `${projectDir}`— Полный путь к папке CMakeLists.txt корневого файла
- `${thisFile}`— Полный путь к файлу CMakeSettings.json
- `${name}`— Имя конфигурации
- `${generator}`— имя генератора CMake, используемый в этой конфигурации

### <a name="ninja-command-line-arguments"></a>Аргументы командной строки ниндзя

Если целевые объекты не заданы, создает целевой объект «default» (см. руководство).

```cmd
C:\Program Files (x86)\Microsoft Visual Studio\Preview\Enterprise>ninja -?
ninja: invalid option -- `-?'
usage: ninja [options] [targets...]
```

|Параметр|Описание:|  
|--------------|------------|  
| — версия  | Печать версии ниндзя («1.7.1»)| 
|   -C DIR   | изменить на DIR перед выполнением других действий| 
|   f - файла  | Укажите файл входной сборки [default=build.ninja]| 
|   -j N     | параллельное выполнение заданий N [по умолчанию = 14, производным от ЦП, доступных]| 
|   -k N     | Продолжайте, пока N заданий завершились сбоем [по умолчанию = 1]| 
|   -l N     | новые задания не запускаются, если среднее значение нагрузки больше, чем N| 
|   -n      | Сухая запуска (не выполнять команды, но действовать так, как они успешно)| 
|   -v       | Показать все командной строки во время построения| 
|   -d режим  | Включите отладку (-d режимы одного списка)| 
|   t - СРЕДСТВО  | Запустите subtool (среди одного списка используйте -t). Завершает параметры верхнего уровня; Дополнительные флаги переданы в средство| 
|   -w ФЛАГ  | Настройка предупреждений (-w предупреждений списка в список)| 


### <a name="inherited-environments-visual-studio-2017-version-155"></a>Наследуемые сред (Visual Studio 2017 г. версия 15,5)

CmakeSettings.json теперь поддерживает inherted среды. Эта функция позволяет создать пользовательскую переменную, которая:

```json
  "inheritEnvironments": [ "msvc_x64_x64" ]
```

Это поле задает переменные, которые автоматически передаются CMake.exe при запуске. В приведенном выше примере является таким же, как при запуске «Командная строка разработчика для VS 2017 г.» с `-arch=amd64 -host_arch=amd64` аргументы.

Ниже приведены поддерживаемые значения и их эквиваленты командной строки:

|Имя контекста|Описание:|  
|-----------|-----------------|
|vsdev|Среда Visual Studio по умолчанию|
|msvc_x86|Компиляция с помощью x86 x86 средства|
|msvc_arm| Компилировать для архитектуры ARM с помощью x86 средств|
|msvc_arm64|Компилировать для ARM64 x86 с помощью средства|
|msvc_x86_x64|Компилировать для AMD64 x86 с помощью средства|
|msvc_x64_x64|Компилировать для AMD64, с помощью средств 64-разрядная версия|
|msvc_arm_x64|Компиляция с помощью 64-разрядные средства ARM|
|msvc_arm64_x64|Компилировать для ARM64 с помощью средств 64-разрядная версия|


При существенных изменений CMakeSettings.json или CMakeLists.txt файлы, Visual Studio автоматически повторно выполняет CMake настроить шаг. Если настройка шаг завершается без ошибок, собранных данных доступны в службах C++ IntelliSense и языка, а также в сборки и отладки операций.

Если несколько проектов CMake использовать то же имя таблицы конфигурации CMake (например, x86-Debug), все они настраиваются и встроенной (в корневой папке свои собственные сборки) при выборе этой конфигурации. Можно отлаживать целевых объектов из всех проектов CMake, участвующие в этой конфигурации CMake.

   ![CMake построить только пункта меню](media/cmake-build-only.png)

Чтобы ограничить сборки и отладки сеансы подмножество проектов в рабочей области, создать новую конфигурацию с уникальным именем в файле CMakeSettings.json и применит его только для этих проектов. При этой конфигурации выбран, IntelliSense, сборке и отладка включается только для тех проектов.

## <a name="troubleshooting-cmake-cache-errors"></a>Устранение неполадок кэша CMake
Если требуются дополнительные сведения о состоянии CMake кэша для диагностики проблемы, откройте в главном меню CMake или в контекстном меню CMakeLists.txt в **обозревателе решений** запустить одну из следующих команд:
- **Просмотр кэша** открывает файл CMakeCache.txt в корневой папке сборки в редакторе. (Любые изменения, внесенные здесь CMakeCache.txt были очищены если очистка кэша. Чтобы внести изменения, которые сохраняются после очистки кэша, в разделе [CMake параметры и настраиваемые конфигурации](#cmake_settings) ранее в этой статье.)
- **Откройте папку кэша** открывает окно проводника в корневой папке построения.  
- **Очистить кэш** удаляет корневой папке построения, чтобы далее CMake настроить шаг начинается с очистки кэша.
- **Создание кэша** принудительно создать шаг, чтобы выполнялось, даже если Visual Studio распознает актуальные среды.

