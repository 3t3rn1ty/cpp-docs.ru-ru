---
title: "Многопоточность. Советы по программированию | Microsoft Docs"
ms.custom: ""
ms.date: "12/05/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-cpp"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "C++"
helpviewer_keywords: 
  - "управление доступом [C++], многопоточность"
  - "взаимодействие [C++], между потоками"
  - "критические разделы [C++]"
  - "сопоставления дескрипторов [C++]"
  - "многопоточность [C++], советы по программированию"
  - "не-MFC потоки [C++]"
  - "объекты [C++], несколько потоков и"
  - "программирование [C++], многопоточные"
  - "синхронизация [C++], многопоточность"
  - "работа с потоками [C++], рекомендации"
  - "работа с потоками [MFC], советы по программированию"
  - "устранение неполадок [C++], многопоточность"
  - "сопоставление дескрипторов Windows [C++]"
ms.assetid: ad14cc70-c91c-4c24-942f-13a75e58bf8a
caps.latest.revision: 8
caps.handback.revision: 8
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
---
# Многопоточность. Советы по программированию
[!INCLUDE[vs2017banner](../../assembler/inline/includes/vs2017banner.md)]

При доступе к данным многопоточные приложения требуют больше внимания, чем однопоточные.  Так как приложения являются многопоточными, одновременно выполняется несколько потоков, и следовательно, либо алгоритмы, либо данные, либо и те и другие должны знать, что данные могут одновременно использоваться более чем одним потоком.  В данном разделе описаны способы предотвращения потенциальных проблем, возникающих при программировании многопоточных приложений с библиотекой Microsoft Foundation Class \(MFC\).  
  
-   [Доступ к объектам из нескольких потоков](#_core_accessing_objects_from_multiple_threads)  
  
-   [Доступ к объектам MFC из потоков, не относящихся к MFC](#_core_accessing_mfc_objects_from_non.2d.mfc_threads)  
  
-   [Сопоставление дескрипторов Windows](#_core_windows_handle_maps)  
  
-   [Взаимодействие между потоками](#_core_communicating_between_threads)  
  
##  <a name="_core_accessing_objects_from_multiple_threads"></a> Доступ к объектам из нескольких потоков  
 В связи с размером и производительностью объекты MFC не являются потокобезопасными на уровне объекта, а являются таковыми только на уровне класса.  Это означает, что два отдельных потока могут управлять двумя различными объектами `CString`, а управление одним объектом `CString` двумя потоками невозможно.  Если для управления одним объектом требуется использовать несколько потоков, то необходимо защитить доступ соответствующими механизмами синхронизации Win32, например, критическими секциями.  Дополнительные сведения о критических секциях и других связанных объектах см. в разделе [Синхронизация](http://msdn.microsoft.com/library/windows/desktop/ms686353) в [!INCLUDE[winsdkshort](../../atl/reference/includes/winsdkshort_md.md)].  
  
 Библиотека классов использует критические секции для защиты глобальных структур данных, например тех, которые используются при распределении отладочной памяти.  
  
##  <a name="_core_accessing_mfc_objects_from_non.2d.mfc_threads"></a> Доступ к объектам MFC из потоков, не относящихся к MFC  
 Если многопоточное приложение создает поток не с помощью объекта [CWinThread](../../mfc/reference/cwinthread-class.md), то из этого потока невозможно будет получить доступ к другим объектам MFC.  Другими словами, если нужно получить доступ к любому объекту MFC из второго потока, то такой поток необходимо создать с помощью методов, описанных в разделе [Многопоточность: создание потоков пользовательского интерфейса](../../parallel/multithreading-creating-user-interface-threads.md) или [Многопоточность: создание рабочих потоков](../../parallel/multithreading-creating-worker-threads.md).  Данные методы позволяют библиотеке классов инициализировать внутренние переменные, необходимые дескрипторам многопоточных приложений.  
  
##  <a name="_core_windows_handle_maps"></a> Сопоставление дескрипторов Windows  
 Как правило, поток может получить доступ только к созданным им объектам MFC.  По этой причине временное и постоянное сопоставление дескрипторов Windows сохраняется в локальном хранилище потока, помогающем реализовать защиту от одновременного доступа нескольких потоков.  Например, рабочий поток не может выполнить расчет и затем вызвать функцию\-член документа `UpdateAllViews` для окон, которые содержат новые измененные данные.  Данное действие не произведет никакого эффекта, потому что сопоставление от объектов `CWnd` объектам `HWND` является локальным для первичного потока.  Это означает, что один поток может сопоставить дескриптор Windows объекту С\+\+, но другой поток может сопоставить тот же дескриптор различным объектам C\+\+.  Изменения, сделанные в одном потоке, не будут отражаться в другом потоке.  
  
 Несколько путей решения данной проблемы.  Первый заключается в передаче в рабочий поток отдельных дескрипторов \(например `HWND`\), а не объектов С\+\+.  Затем рабочий поток добавит данные объекты во временное сопоставление, вызывая соответствующую функцию\-член `FromHandle`.  Можно также добавить объект в постоянное сопоставление потока, вызывая **Attach**, но только при условии гарантии того, что объект будет существовать дольше, чем поток.  
  
 Другой метод заключается в создании новых заданных пользователем сообщений, соответствующих различным задачам рабочих потоков, которые создают и помещают эти сообщения в главное окно приложения с помощью метода **::PostMessage**.  Данный метод взаимодействия похож на диалог двух различных приложений, за исключением того, что оба потока выполняются в одном адресном пространстве.  
  
 Дополнительные сведения о сопоставлении дескрипторов см. в разделе [Технические замечания 3](../../mfc/tn003-mapping-of-windows-handles-to-objects.md).  Дополнительные сведения о локальном хранилище потока см. в разделе [Локальное хранилище потока](http://msdn.microsoft.com/library/windows/desktop/ms686749) и [Использование локального хранилища потока](http://msdn.microsoft.com/library/windows/desktop/ms686991) в [!INCLUDE[winsdkshort](../../atl/reference/includes/winsdkshort_md.md)].  
  
##  <a name="_core_communicating_between_threads"></a> Взаимодействие между потоками  
 MFC предоставляет несколько классов, которые позволяют потокам синхронизировать доступ к объектам для обеспечения безопасности потока.  Использование данных классов описано в [Многопоточность. Использование классов синхронизации](../../parallel/multithreading-how-to-use-the-synchronization-classes.md) и [Многопоточность. Случаи использования классов синхронизации](../../parallel/multithreading-when-to-use-the-synchronization-classes.md).  Дополнительные сведения об этих объектах см. в разделе [Синхронизация](http://msdn.microsoft.com/library/windows/desktop/ms686353) в [!INCLUDE[winsdkshort](../../atl/reference/includes/winsdkshort_md.md)].  
  
## См. также  
 [Реализация многопоточности на языке C\+\+ с помощью классов MFC](../../parallel/multithreading-with-cpp-and-mfc.md)