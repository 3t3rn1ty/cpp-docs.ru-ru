---
title: 'Многопоточность: Советы по программированию | Документы Microsoft'
ms.custom: ''
ms.date: 11/04/2016
ms.technology:
- cpp-parallel
ms.topic: conceptual
dev_langs:
- C++
helpviewer_keywords:
- multithreading [C++], programming tips
- handle maps [C++]
- access control [C++], multithreading
- objects [C++], multiple threads and
- non-MFC threads [C++]
- threading [MFC], programming tips
- critical sections [C++]
- synchronization [C++], multithreading
- programming [C++], multithreaded
- communications [C++], between threads
- threading [C++], best practices
- troubleshooting [C++], multithreading
- Windows handle maps [C++]
ms.assetid: ad14cc70-c91c-4c24-942f-13a75e58bf8a
author: mikeblome
ms.author: mblome
ms.workload:
- cplusplus
ms.openlocfilehash: b9c4241b9257244de840db1f57c5e7abcb32f206
ms.sourcegitcommit: 7019081488f68abdd5b2935a3b36e2a5e8c571f8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2018
ms.locfileid: "33689991"
---
# <a name="multithreading-programming-tips"></a>Многопоточность. Советы по программированию
Многопоточные приложения требуют больше внимания, чем однопоточные при доступе к данным. Так как существует несколько, независимых путей выполнения в одновременно использовать в многопоточных приложениях алгоритмы, данные или оба следует иметь в виду эти данные могут использоваться несколько потоков одновременно. В этом разделе описаны способы предотвращения потенциальных проблем при программировании многопоточных приложений с помощью библиотеки Microsoft Foundation Class (MFC).  
  
-   [Доступ к объектам из нескольких потоков](#_core_accessing_objects_from_multiple_threads)  
  
-   [Доступ к объектам MFC из потоков, не являющихся MFC](#_core_accessing_mfc_objects_from_non.2d.mfc_threads)  
  
-   [Сопоставление дескрипторов Windows](#_core_windows_handle_maps)  
  
-   [Взаимодействие между потоками](#_core_communicating_between_threads)  
  
##  <a name="_core_accessing_objects_from_multiple_threads"></a> Доступ к объектам из нескольких потоков  
 В целях размер и производительность MFC объекты не поточно ориентированного на уровне объектов, только на уровне класса. Это означает, что можно иметь два отдельных потока могут управлять двумя различными `CString` объектов, но не двух потоков, управление одним `CString` объекта. Если это совершенно необходимо иметь несколько потоков, контролирующих тот же объект, защитить доступ соответствующими механизмами синхронизации Win32, таких как критические секции. Дополнительные сведения о критических секциях и других связанных объектов, см. в разделе [синхронизации](http://msdn.microsoft.com/library/windows/desktop/ms686353) в [!INCLUDE[winsdkshort](../atl-mfc-shared/reference/includes/winsdkshort_md.md)].  
  
 Библиотека классов использует критические секции для защиты глобальных структур данных, например используемые отладочное выделение памяти.  
  
##  <a name="_core_accessing_mfc_objects_from_non.2d.mfc_threads"></a> Доступ к объектам MFC из потоков, не являющихся MFC  
 Если у вас есть многопоточного приложения, которое создает поток не с помощью с [CWinThread](../mfc/reference/cwinthread-class.md) объекта, не может получить доступ к другим объектам MFC из этого потока. Другими словами, если вы хотите получить доступ к любому объекту MFC из второго потока, необходимо создать этот поток с помощью одного из методов, описанных в [Многопоточность: создание потоков пользовательского интерфейса](../parallel/multithreading-creating-user-interface-threads.md) или [Многопоточность: Создание рабочих потоков](../parallel/multithreading-creating-worker-threads.md). Эти методы считаются только те, которые позволяют библиотеке классов инициализировать внутренние переменные, необходимые для обработки многопоточных приложений.  
  
##  <a name="_core_windows_handle_maps"></a> Сопоставление дескрипторов Windows  
 Как правило поток может включить только объекты MFC, которые он создан. Это так, как временное и полное сопоставление дескрипторов Windows хранятся в локальном хранилище потока в целях обеспечения защиты от одновременного доступа нескольких потоков. Например, рабочий поток не может выполнить расчет и вызывается документа `UpdateAllViews` функции-члена для окон, которые содержат новые измененные данные. Не действует, так как сопоставление от `CWnd` объектов `HWND`s является локальным для основного потока. Это означает, что один поток может иметь сопоставление из дескриптора Windows для объекта C++, но другой поток может сопоставить тот же дескриптор различным объектам C++. Изменения, внесенные в одном потоке, не отражались в другой.  
  
 Существует несколько способов решения этой проблемы. Первый заключается в передаче отдельных дескрипторов (например, `HWND`) вместо объектов C++ на рабочий поток. Рабочий поток затем добавит данные объекты во временное сопоставление, вызывая соответствующую `FromHandle` функции-члена. Можно также добавить объект в постоянное сопоставление потока, вызвав **присоединение**, но это следует делать только в том случае, если вам гарантируется, что объект будет существовать дольше, чем поток.  
  
 Другой метод заключается в создании новых определяемых пользователем сообщений, соответствующих различным задачам рабочих потоков будет и помещают эти сообщения в главное окно приложения с помощью **:: PostMessage**. Данный метод взаимодействия аналогична диалог, за исключением того, что оба потока выполняются в том же адресном пространстве двух различных приложений.  
  
 Дополнительные сведения о сопоставлении дескрипторов см. в разделе [технические Примечание 3](../mfc/tn003-mapping-of-windows-handles-to-objects.md). Дополнительные сведения о локальном хранилище потока см. в разделе [локальное хранилище потока](http://msdn.microsoft.com/library/windows/desktop/ms686749) и [с помощью локального хранилища потока](http://msdn.microsoft.com/library/windows/desktop/ms686991) в [!INCLUDE[winsdkshort](../atl-mfc-shared/reference/includes/winsdkshort_md.md)].  
  
##  <a name="_core_communicating_between_threads"></a> Взаимодействие между потоками  
 MFC предоставляет классы, позволяющие потоков для синхронизации доступа к объектам для обеспечения потокобезопасности. Описывается использование этих классов в [Многопоточность: использование классов синхронизации](../parallel/multithreading-how-to-use-the-synchronization-classes.md) и [Многопоточность: использование классов синхронизации](../parallel/multithreading-when-to-use-the-synchronization-classes.md). Дополнительные сведения об этих объектах см. в разделе [синхронизации](http://msdn.microsoft.com/library/windows/desktop/ms686353) в [!INCLUDE[winsdkshort](../atl-mfc-shared/reference/includes/winsdkshort_md.md)].  
  
## <a name="see-also"></a>См. также  
 [Реализация многопоточности на языке C++ с помощью классов MFC](../parallel/multithreading-with-cpp-and-mfc.md)