---
title: "Многопоточность. Завершение потоков | Microsoft Docs"
ms.custom: ""
ms.date: "12/05/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-cpp"
ms.tgt_pltfrm: ""
ms.topic: "article"
f1_keywords: 
  - "CREATE_SUSPENDED"
dev_langs: 
  - "C++"
helpviewer_keywords: 
  - "AfxEndThread - метод"
  - "многопоточность [C++], завершение работы с потоками"
  - "преждевременное завершение потока"
  - "запуск потоков"
  - "остановка потоков"
  - "завершение работы с потоками"
  - "работа с потоками [C++], остановка потоков"
  - "работа с потоками [MFC], завершение работы с потоками"
ms.assetid: 4c0a8c6d-c02f-456d-bd02-0a8c8d006ecb
caps.latest.revision: 9
caps.handback.revision: 9
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
---
# Многопоточность. Завершение потоков
[!INCLUDE[vs2017banner](../assembler/inline/includes/vs2017banner.md)]

Обычно завершение потока может произойти в двух случаях: если завершается выполнение контролирующей функции или если у потока нет разрешения на выполнение до конца.  При использовании текстовым процессором потока для выполнения печати в фоновом режиме контролирующая функция завершается при успешном выполнении задания печати.  Если необходимо отменить печать, сначала следует завершить поток для печати в фоновом режиме.  В данном разделе рассматриваются оба эти случая, а также способы получения кода выхода из потока после его завершения.  
  
-   [Обычное завершение потока](#_core_normal_thread_termination)  
  
-   [Преждевременное завершение потока](#_core_premature_thread_termination)  
  
-   [Извлечение кода выхода из потока](#_core_retrieving_the_exit_code_of_a_thread)  
  
##  <a name="_core_normal_thread_termination"></a> Обычное завершение потока  
 Завершение рабочего потока выполняется просто: нужно просто завершить контролирующую функцию и возвратить значение, обозначающее причину завершения потока.  Для этого можно использовать либо функцию [AfxEndThread](../Topic/AfxEndThread.md), либо оператор `return`.  Обычно для обозначения успешного завершения используется значение "0", но можно выбрать и другое значение.  
  
 Завершение потока пользовательского интерфейса происходит так же просто: следует вызвать функцию [PostQuitMessage](http://msdn.microsoft.com/library/windows/desktop/ms644945) \([!INCLUDE[winsdkshort](../atl/reference/includes/winsdkshort_md.md)]\) внутри потока пользовательского интерфейса.  Единственный параметр, который использует функция **PostQuitMessage** — это код выхода из потока.  Как и для рабочих потоков, успешное завершение, как правило, обозначается возвратом значения "0".  
  
##  <a name="_core_premature_thread_termination"></a> Преждевременное завершение потока  
 Преждевременное завершение потока выполняется почти так же просто. Следует вызвать функцию [AfxEndThread](../Topic/AfxEndThread.md) в потоке.  Передайте необходимый код выхода в качестве единственного параметра.  Это приведет к остановке выполнения потока, отмене выделения памяти для потока в стеке, отключению всех библиотек DLL, используемых потоком, и удалению объекта потока из памяти.  
  
 Функцию `AfxEndThread` необходимо вызывать в завершаемом потоке.  При необходимости завершить поток из другого потока, необходимо установить метод взаимодействия между этими потоками.  
  
##  <a name="_core_retrieving_the_exit_code_of_a_thread"></a> Извлечение кода выхода из потока  
 Чтобы получить код выхода из рабочего потока или потока пользовательского интерфейса, следует вызвать функцию [GetExitCodeThread](http://msdn.microsoft.com/library/windows/desktop/ms683190).  Дополнительные сведения об этой функции см. [!INCLUDE[winsdkshort](../atl/reference/includes/winsdkshort_md.md)].  Эта функция принимает дескриптор потока \(который хранится в элементе данных `m_hThread` объектов `CWinThread`\) и адрес параметра `DWORD`.  
  
 Если поток все еще активен, функция **GetExitCodeThread** передает значение **STILL\_ACTIVE** по указанному адресу `DWORD`. В противном случае по этому адресу передается код выхода.  
  
 Для извлечения кода выхода из объектов [CWinThread](../mfc/reference/cwinthread-class.md) необходимо выполнить дополнительное действие.  При завершении потока `CWinThread` объект потока по умолчанию удаляется.  Это означает, что невозможно получить доступ к элементу данных `m_hThread`, поскольку объект `CWinThread` больше не существует.  Чтобы избежать данной ситуации, выполните одно из следующих действий:  
  
-   Задайте для элемента данных `m_bAutoDelete` значение **FALSE**.  Это отменит автоматическое удаление объекта `CWinThread` после завершения потока.  Теперь можно обращаться к элементу данных `m_hThread` и после завершения потока.  При использовании этого метода следует вручную удалить объект `CWinThread`, поскольку платформа не выполнит удаление автоматически.  Этот метод является предпочтительным.  
  
-   Дескриптор потока следует хранить отдельно.  После создания потока скопируйте его элемент данных `m_hThread` \(с помощью функции **::DuplicateHandle**\) в другую переменную и обращайтесь к нему с помощью этой переменной.  Этот метод позволяет узнать причину завершения потока, хотя объект при этом удаляется автоматически.  Обратите внимание, что дескриптор необходимо скопировать до завершения потока.  Наиболее безопасным способом для этого является передача **CREATE\_SUSPENDED** в функцию [AfxBeginThread](../Topic/AfxBeginThread.md), сохранение дескриптора, а затем возобновление потока с помощью функции [ResumeThread](../Topic/CWinThread::ResumeThread.md).  
  
 Любой из этих способов позволяет определить причину завершения объекта `CWinThread`.  
  
## См. также  
 [Реализация многопоточности на языке C\+\+ с помощью классов MFC](../parallel/multithreading-with-cpp-and-mfc.md)   
 [\_endthread, \_endthreadex](../Topic/_endthread,%20_endthreadex.md)   
 [\_beginthread, \_beginthreadex](../Topic/_beginthread,%20_beginthreadex.md)   
 [ExitThread](http://msdn.microsoft.com/library/windows/desktop/ms682659)