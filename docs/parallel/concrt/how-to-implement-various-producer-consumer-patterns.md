---
title: "Практическое руководство. Реализация различных шаблонов &quot;источник-приемник&quot; | Microsoft Docs"
ms.custom: ""
ms.date: "11/04/2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-cpp"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "C++"
helpviewer_keywords: 
  - "шаблоны "источник-приемник", реализация [среда выполнения с параллелизмом]"
  - "реализация шаблонов "источник-приемник" [среда выполнения с параллелизмом]"
ms.assetid: 75f2c7cc-5399-49ea-98eb-847fe6747169
caps.latest.revision: 17
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
caps.handback.revision: 14
---
# Практическое руководство. Реализация различных шаблонов &quot;источник-приемник&quot;
[!INCLUDE[vs2017banner](../../assembler/inline/includes/vs2017banner.md)]

В этом разделе описана реализация шаблона "производитель\-получатель" в приложении.  В этом шаблоне *производитель* отправляет сообщения в блок сообщений, а *получатель* считывает сообщения из этого блока.  
  
 В разделе показано два сценария.  В первом сценарии получатель должен получить каждое сообщение, отправленное производителем.  Во втором сценарии получатель запрашивает данные периодически и поэтому не обязательно получает каждое сообщение.  
  
 В обоих примерах в этом разделе для передачи сообщений от производителя получателю используются агенты, блоки сообщений и функции передачи сообщений.  Агент производителя использует функцию [concurrency::send](../Topic/send%20Function.md) для записи сообщений в объект [concurrency::ITarget](../../parallel/concrt/reference/itarget-class.md).  Для чтения сообщений из объекта [concurrency::receive](../Topic/receive%20Function.md) агент потребителя использует функцию [concurrency::ISource](../../parallel/concrt/reference/isource-class.md).  Оба агента содержат значение\-метку, чтобы координировать завершение обработки.  
  
 Дополнительные сведения об асинхронных агентах см. в разделе [Асинхронные агенты](../../parallel/concrt/asynchronous-agents.md).  Дополнительные сведения о блоках сообщений и функциях передачи сообщений см. в разделах [Асинхронные блоки сообщений](../../parallel/concrt/asynchronous-message-blocks.md) и [Функции передачи сообщений](../../parallel/concrt/message-passing-functions.md).  
  
## Пример  
 В этом примере агент производителя отправляет агенту получателя ряд чисел.  Получатель принимает эти числа и вычисляет их среднее значение.  Приложение выводит среднее на консоль.  
  
 В этом примере для предоставления производителю возможности ставить сообщения в очередь используется объект [concurrency::unbounded\_buffer](../Topic/unbounded_buffer%20Class.md).  Класс `unbounded_buffer` реализует `ITarget` и `ISource`, чтобы производитель и получатель могли отправлять сообщения в общий буфер и получать их из него.  Функции `send` и `receive` координируют задачу передачи данных от производителя к получателю.  
  
 [!code-cpp[concrt-producer-consumer-average#1](../../parallel/concrt/codesnippet/CPP/how-to-implement-various-producer-consumer-patterns_1.cpp)]  
  
 В результате выполнения примера получается следующий результат:  
  
  **Среднее значение — 50.**   
## Пример  
 В этом примере агент производителя отправляет агенту получателя ряд биржевых котировок.  Агент получателя периодически выполняет чтение текущей котировки и выводит ее на консоль.  
  
 Этот пример похож на предыдущий за исключением того, что в нем для разрешения совместного использования одного сообщения производителем и получателем используется объект [concurrency::overwrite\_buffer](../../parallel/concrt/reference/overwrite-buffer-class.md).  Как и в предыдущем примере, класс `overwrite_buffer` реализует объекты `ITarget` и `ISource`, чтобы производитель и получатель могли совместно работать с одним буфером сообщений.  
  
 [!code-cpp[concrt-producer-consumer-quotes#1](../../parallel/concrt/codesnippet/CPP/how-to-implement-various-producer-consumer-patterns_2.cpp)]  
  
 В данном примере получается следующий результат.  
  
  **Текущее значение — 24.44.**  
**Текущее значение — 24.44.**  
**Текущее значение — 24.65.**  
**Текущее значение — 24.99.**  
**Текущее значение — 23.76.**  
**Текущее значение — 22.30.**  
**Текущее значение — 25.89.** В отличие от объекта `unbounded_buffer`, функция `receive` не удаляет сообщение из объекта `overwrite_buffer`.  Если получатель выполняет чтение из буфера сообщений более одного раза, прежде чем производитель перезапишет это сообщение, приемник получает это сообщение столько раз, сколько было выполнено чтение.  
  
## Компиляция кода  
 Скопируйте код примера и вставьте его в проект Visual Studio или в файл с именем `producer-consumer.cpp`, затем выполните в окне командной строки Visual Studio следующую команду.  
  
 **cl.exe \/EHsc producer\-consumer.cpp**  
  
## См. также  
 [Библиотека асинхронных агентов](../../parallel/concrt/asynchronous-agents-library.md)   
 [Асинхронные агенты](../../parallel/concrt/asynchronous-agents.md)   
 [Асинхронные блоки сообщений](../../parallel/concrt/asynchronous-message-blocks.md)   
 [Функции передачи сообщений](../../parallel/concrt/message-passing-functions.md)