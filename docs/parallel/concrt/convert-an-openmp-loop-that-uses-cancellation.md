---
title: "Практическое руководство. Преобразование цикла OpenMP, использующего отмену для использования среды выполнения с параллелизмом | Microsoft Docs"
ms.custom: ""
ms.date: "12/05/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-cpp"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "C++"
helpviewer_keywords: 
  - "преобразование OpenMP в среду выполнения с параллелизмом, отмена"
  - "отмена, преобразование OpenMP в среду выполнения с параллелизмом"
ms.assetid: 4b0b3c33-bfa9-4e96-ae08-aef245a39cbb
caps.latest.revision: 11
caps.handback.revision: 8
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
---
# Практическое руководство. Преобразование цикла OpenMP, использующего отмену для использования среды выполнения с параллелизмом
[!INCLUDE[vs2017banner](../../assembler/inline/includes/vs2017banner.md)]

В некоторых параллельных циклах не обязательно выполнять все итерации.  Например, алгоритм, ищущий значение, может завершить работу, когда значение найдено.  В OpenMP нет механизма прекращения параллельного цикла.  Тем не менее, можно использовать логическое значение, флаг или позволить итерации цикла указывать, что решение найдено.  Среда выполнения с параллелизмом содержит функцию, позволяющую одной задаче отменять другие, еще не начатые, задачи.  
  
 В этом примере показано, как преобразовать цикл OpenMP [parallel](../../parallel/openmp/reference/parallel.md) [for](../Topic/for%20\(OpenMP\).md), для которого не требуется выполнение всех итераций, для выполнения с использованием механизма отмены среды выполнения с параллелизмом.  
  
## Пример  
 В этом примере для реализации параллельной версии алгоритма [std::any\_of](../Topic/any_of.md) используется как OpenMP, так и среда выполнения с параллелизмом.  В версии этого примера, использующей OpenMP, для сообщения всем параллельным итерациям цикла о том, что выполнено некое условие, применяется флаг.  В версии, использующей среду выполнения с параллелизмом, для остановки общей операции при выполнении условия используется метод [concurrency::structured\_task\_group::cancel](../Topic/structured_task_group::cancel%20Method.md).  
  
 [!code-cpp[concrt-openmp#2](../../parallel/concrt/codesnippet/CPP/convert-an-openmp-loop-that-uses-cancellation_1.cpp)]  
  
 В результате выполнения примера получается следующий результат:  
  
  **Использование OpenMP…**  
**9114046 в массиве.**  
**использование среды выполнения с параллелизмом...**  
**9114046 в массиве.** В версии, использующей OpenMP, все итерации цикла выполняются, даже когда флаг установлен.  Поэтому если у задачи есть дочерние задачи, флаг будет доступен для этих дочерних задач, чтобы они могли узнать об отмене.  В среде выполнения с параллелизмом при отмене задачи среда отменяет все дерево работы, включая дочерние задачи.  Алгоритм [concurrency::parallel\_for\_each](../Topic/parallel_for_each%20Function.md) выполняет работу с помощью задач.  Поэтому если одна итерация цикла отменяет корневую задачу, отменяется все дерево вычислений.  При отмене дерева работы среда выполнения не запускает новые задачи.  При этом среда выполнения позволяет завершиться всем начатым задачам.  Таким образом, в случае алгоритма `parallel_for_each` активные итерации цикла могут очистить свои ресурсы.  
  
 В обоих версиях примера несколько итераций цикла могут одновременно задавать результат и отменять общую операцию, если массив содержит более одной копии искомого значения.  Можно использовать примитив синхронизации, например критичный участок, если для решения проблемы нужно, чтобы при выполнении условия только одна задача выполняла работу.  
  
 Для отмены задач, использующих PPL, также можно использовать обработку исключений.  Дополнительные сведения об отмене см. в разделе [Отмена](../../parallel/concrt/cancellation-in-the-ppl.md).  
  
 Дополнительные сведения об алгоритме `parallel_for_each` и других параллельных алгоритмах см. в разделе [Параллельные алгоритмы](../Topic/Parallel%20Algorithms.md).  
  
## Компиляция кода  
 Скопируйте код примера и вставьте его в проект Visual Studio или в файл с именем `concrt-omp-parallel-any-of.cpp`, затем выполните в окне командной строки Visual Studio следующую команду.  
  
 **cl.exe \/EHsc \/openmp concrt\-omp\-parallel\-any\-of.cpp**  
  
## См. также  
 [Переход от OpenMP к среде выполнения с параллелизмом](../../parallel/concrt/migrating-from-openmp-to-the-concurrency-runtime.md)   
 [Отмена](../../parallel/concrt/cancellation-in-the-ppl.md)   
 [Параллельные алгоритмы](../Topic/Parallel%20Algorithms.md)