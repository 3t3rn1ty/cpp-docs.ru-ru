---
title: "Практическое руководство. Преобразование цикла OpenMP, использующего обработку исключений для использования среды выполнения с параллелизмом | Microsoft Docs"
ms.custom: ""
ms.date: "12/05/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-cpp"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "C++"
helpviewer_keywords: 
  - "обработка исключений, преобразование OpenMP в среду выполнения с параллелизмом"
  - "преобразование OpenMP в среду выполнения с параллелизмом, обработка исключений"
ms.assetid: 03c28196-21ba-439e-8641-afab1c283e1a
caps.latest.revision: 11
caps.handback.revision: 8
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
---
# Практическое руководство. Преобразование цикла OpenMP, использующего обработку исключений для использования среды выполнения с параллелизмом
[!INCLUDE[vs2017banner](../../assembler/inline/includes/vs2017banner.md)]

В этом примере показано, как преобразовать цикл OpenMP [parallel](../../parallel/openmp/reference/parallel.md) [for](../Topic/for%20\(OpenMP\).md), позволяющий использовать механизм обработки исключений среды выполнения с параллелизмом.  
  
 В OpenMP исключение, возникшее в параллельной области, должно быть перехвачено и обработано в той же области тем же потоком.  Исключение, покинувшее параллельную область, перехватывается обработчиком необработанных исключений, который по умолчанию завершает процесс.  
  
 В среде выполнения с параллелизмом при создании исключения в основной части рабочей функции, передаваемой такой группе задач, как объект [concurrency::task\_group](../Topic/task_group%20Class.md) или [concurrency::structured\_task\_group](../../parallel/concrt/reference/structured-task-group-class.md), либо такому параллельному алгоритму, как [concurrency::parallel\_for](../Topic/parallel_for%20Function.md), среда выполнения сохраняет это исключение и маршалирует его в контекст, ожидающий завершения группы задач или алгоритма.  Для групп задач ожидающим контекстом является контекст, вызывающий метод [concurrency::task\_group::wait](../Topic/task_group::wait%20Method.md), [concurrency::structured\_task\_group::wait](../Topic/structured_task_group::wait%20Method.md), [concurrency::task\_group::run\_and\_wait](../Topic/task_group::run_and_wait%20Method.md) или [concurrency::structured\_task\_group::run\_and\_wait](../Topic/structured_task_group::run_and_wait%20Method.md).  Для параллельного алгоритма ожидающим является контекст, вызвавший этот алгоритм.  Среда выполнения также останавливает все активные задачи в данной группе задач, включая задачи дочерних групп, и удаляет все не начатые задачи.  
  
## Пример  
 В этом примере показано, как обрабатывать исключения в области OpenMP `parallel` и в вызове к `parallel_for`.  Функция `do_work` выполняет запрос выделения памяти, который заканчивается неудачей и создает исключение типа [std::bad\_alloc](../../standard-library/bad-alloc-class.md).  В версии, использующей OpenMP, поток, создающий исключение, должен его перехватить.  Иными словами, каждая итерация параллельного цикла OpenMP должна обрабатывать исключение.  В версии, использующей среду выполнения с параллелизмом, основной поток перехватывает исключение, созданное другим потоком.  
  
 [!code-cpp[concrt-openmp#3](../../parallel/concrt/codesnippet/CPP/convert-an-openmp-loop-that uses-exception-handling_1.cpp)]  
  
 В результате выполнения примера получается следующий результат:  
  
  **Использование OpenMP…**  
**Произошла ошибка типа «std::bad\_alloc».**  
**Произошла ошибка типа «std::bad\_alloc».**  
**Произошла ошибка типа «std::bad\_alloc».**  
**Произошла ошибка типа «std::bad\_alloc».**  
**Произошла ошибка типа «std::bad\_alloc».**  
**Произошла ошибка типа «std::bad\_alloc».**  
**Произошла ошибка типа «std::bad\_alloc».**  
**Произошла ошибка типа «std::bad\_alloc».**  
**Произошла ошибка типа «std::bad\_alloc».**  
**Произошла ошибка типа «std::bad\_alloc».**  
**использование среды выполнения с параллелизмом...**  
**Произошла ошибка типа «std::bad\_alloc».** В версии этого примера, использующей OpenMP, исключение возникает и обрабатывается в каждой итерации цикла.  В версии, использующей среду выполнения с параллелизмом, среда выполнения сохраняет исключение, останавливает все активные задачи, удаляет все не начатые задачи и маршалирует исключение в контекст, вызывающий метод `parallel_for`.  
  
 Если нужно, чтобы версия, использующая OpenMP, завершала работу после возникновения исключения, можно использовать логический флаг, указывающий другим итерациям цикла, что произошла ошибка.  Если задан этот флаг, последующие итерации не будут делать ничего, как в примере в разделе [Практическое руководство. Преобразование цикла OpenMP, использующего отмену для использования среды выполнения с параллелизмом](../../parallel/concrt/convert-an-openmp-loop-that-uses-cancellation.md).  И наоборот, если нужно, чтобы цикл, использующий среду выполнения с параллелизмом, продолжал работу после возникновения исключения, следует обрабатывать исключение в самом основной части параллельного цикла.  
  
 Другие компоненты среды выполнения с параллелизмом, например асинхронные агенты и упрощенные задачи, не транспортируют исключения.  Вместо этого необработанные исключения перехватываются обработчиком необработанных исключений, который по умолчанию завершает процесс.  Дополнительные сведения об обработке исключений см. в разделе [Обработка исключений](../Topic/Exception%20Handling%20in%20the%20Concurrency%20Runtime.md).  
  
 Дополнительные сведения об алгоритме `parallel_for` и других параллельных алгоритмах см. в разделе [Параллельные алгоритмы](../Topic/Parallel%20Algorithms.md).  
  
## Компиляция кода  
 Скопируйте пример кода и вставьте его в проект Visual Studio или файл с именем `concrt-omp-exceptions.cpp`, затем выполните в окне командной строки Visual Studio следующую команду.  
  
 **cl.exe \/EHsc \/openmp concrt\-omp\-exceptions.cpp**  
  
## См. также  
 [Переход от OpenMP к среде выполнения с параллелизмом](../../parallel/concrt/migrating-from-openmp-to-the-concurrency-runtime.md)   
 [Обработка исключений](../Topic/Exception%20Handling%20in%20the%20Concurrency%20Runtime.md)   
 [Параллельные алгоритмы](../Topic/Parallel%20Algorithms.md)