---
title: "Пошаговое руководство. Удаление задач из потоков пользовательского интерфейса | Microsoft Docs"
ms.custom: ""
ms.date: "12/14/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-cpp"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "C++"
helpviewer_keywords: 
  - "удаление работы из потоков пользовательского интерфейса [среда выполнения с параллелизмом]"
  - "потоки пользовательского интерфейса, удаление работы из [среда выполнения с параллелизмом]"
ms.assetid: a4a65cc2-b3bc-4216-8fa8-90529491de02
caps.latest.revision: 14
caps.handback.revision: 13
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
---
# Пошаговое руководство. Удаление задач из потоков пользовательского интерфейса
[!INCLUDE[vs2017banner](../../assembler/inline/includes/vs2017banner.md)]

В этом документе показано, как использовать среду выполнения с параллелизмом для перемещения работ, выполняемых потоком пользовательского интерфейса в приложении Microsoft Foundation Classes \(MFC\), в рабочий поток.  Также в документе показано, как улучшить производительность продолжительной операции по отрисовке.  
  
 Удаление выполняемой работы из потока пользовательского интерфейса путем выгрузки блокирующих операций, например отрисовки, в рабочий поток, может уменьшить время отклика приложения.  В этом пошаговом руководстве в качестве примера длительной блокирующей операции используется процедура отрисовки фрактала Мандельброта.  Отрисовка фрактала Мандельброта также является хорошим кандидатом для параллелизации, поскольку вычисление каждого пикселя не зависит от других вычислений.  
  
## Обязательные компоненты  
 Прежде чем начать выполнение этого пошагового руководства, необходимо ознакомиться со следующими разделами.  
  
-   [Параллелизм задач](../../parallel/concrt/task-parallelism-concurrency-runtime.md)  
  
-   [Асинхронные блоки сообщений](../../parallel/concrt/asynchronous-message-blocks.md)  
  
-   [Функции передачи сообщений](../../parallel/concrt/message-passing-functions.md)  
  
-   [Параллельные алгоритмы](../Topic/Parallel%20Algorithms.md)  
  
-   [Отмена](../../parallel/concrt/cancellation-in-the-ppl.md)  
  
 Также перед освоением этого пошагового руководства рекомендуется разобраться в основах разработки приложений MFC и [!INCLUDE[ndptecgdiplus](../../parallel/concrt/includes/ndptecgdiplus_md.md)].  Дополнительные сведения о MFC см. в разделе [Приложения MFC для рабочего стола](../../mfc/mfc-desktop-applications.md).  Дополнительные сведения о [!INCLUDE[ndptecgdiplus](../../parallel/concrt/includes/ndptecgdiplus_md.md)] см. в разделе [GDI\+](_gdiplus_GDI_start_cpp).  
  
##  <a name="top"></a> Подразделы  
 Это пошаговое руководство содержит следующие подразделы.  
  
-   [Создание MFC приложения](#application)  
  
-   [Реализация версии приложения, последовательно рассчитывающей фрактал Мандельброта](#serial)  
  
-   [Удаление задач из потоков пользовательского интерфейса](#removing-work)  
  
-   [Повышение производительности отрисовки](#performance)  
  
-   [Добавление поддержки отмены](#cancellation)  
  
##  <a name="application"></a> Создание MFC приложения  
 В этом разделе описывается, как создать простое приложение MFC.  
  
### Создание нового приложения Visual C\+\+ MFC  
  
1.  В меню **Файл** последовательно выберите пункты **Создать** и **Проект**.  
  
2.  В области **Установленные шаблоны** диалогового окна **Новый проект** выберите **Visual C\+\+**, а затем в области **Шаблоны** выберите **MFC Application**.  Введите имя проекта, например `Мандельброт`, затем нажмите кнопку **ОК**, чтобы отобразить **Мастер приложений MFC**.  
  
3.  На панели **Тип приложения** выберите **Один документ**.  Убедитесь, что флажок **Поддержка архитектуры Document\/View** снят.  
  
4.  Нажмите **Готово**, чтобы создать проект и закрыть **Мастер приложений MFC**.  
  
     Убедитесь, что приложение было успешно создано, выполнив его построение и запуск.  Для построения приложения в меню **Построение** выберите команду **Построить решение**.  Если построение приложения выполнено успешно, запустите приложение, нажав кнопку **Начать отладку** в меню **Отладка**.  
  
##  <a name="serial"></a> Реализация версии приложения, последовательно рассчитывающей фрактал Мандельброта  
 В этом разделе описано, как выполнить отрисовку фрактала Мандельброта.  Эта версия отрисовывает фрактал Мандельброта в виде объекта [!INCLUDE[ndptecgdiplus](../../parallel/concrt/includes/ndptecgdiplus_md.md)] [Bitmap](https://msdn.microsoft.com/en-us/library/ms534420.aspx) и затем копирует содержимое этого растрового изображения в клиентское окно.  
  
#### Реализация версии приложения, последовательно рассчитывающей фрактал Мандельброта  
  
1.  Добавьте в файл stdafx.h следующую директиву `#include`.  
  
     [!code-cpp[concrt-mandelbrot#1](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_1.h)]  
  
2.  В файле ChildView.h после директивы `pragma` определите тип `BitmapPtr`.  Тип `BitmapPtr` позволяет нескольким компонентам совместно использовать указатель на объект `Bitmap`.  Объект `Bitmap` удаляется, если на него больше не ссылается ни один компонент.  
  
     [!code-cpp[concrt-mandelbrot#2](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_2.h)]  
  
3.  В файле ChildView.h добавьте следующий код в раздел `protected` класса `CChildView`.  
  
     [!code-cpp[concrt-mandelbrot#3](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_3.h)]  
  
4.  В файле ChildView.cpp закомментируйте или удалите следующие строки.  
  
     [!code-cpp[concrt-mandelbrot#4](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_4.cpp)]  
  
     При отладочном построении этот шаг предотвращает использование приложением распределителя `DEBUG_NEW`, несовместимого с [!INCLUDE[ndptecgdiplus](../../parallel/concrt/includes/ndptecgdiplus_md.md)].  
  
5.  В файле ChildView.cpp добавьте директиву `using` в пространство имен `Gdiplus`.  
  
     [!code-cpp[concrt-mandelbrot#5](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_5.cpp)]  
  
6.  Добавьте следующий код к конструктору и деструктору класса `CChildView` для инициализации и завершения [!INCLUDE[ndptecgdiplus](../../parallel/concrt/includes/ndptecgdiplus_md.md)].  
  
     [!code-cpp[concrt-mandelbrot#6](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_6.cpp)]  
  
7.  Реализуйте метод `CChildView::DrawMandelbrot`.  Данный метод отрисовывает фрактал Мандельброта в виде объекта типа `Bitmap`.  
  
     [!code-cpp[concrt-mandelbrot#7](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_7.cpp)]  
  
8.  Реализуйте метод `CChildView::OnPaint`.  Этот метод вызывает метод `CChildView::DrawMandelbrot` и затем копирует содержимое объекта `Bitmap` в окно.  
  
     [!code-cpp[concrt-mandelbrot#8](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_8.cpp)]  
  
9. Убедитесь, что приложение было успешно обновлено, выполнив его построение и запуск.  
  
 На следующем рисунке показаны результаты выполнения приложения "Мандельброт".  
  
 ![Приложение "Мандельброт"](../Image/Mandelbrot.png "Mandelbrot")  
  
 Поскольку вычисление каждого пикселя требует больших затрат вычислительной мощности, поток пользовательского интерфейса не способен обрабатывать дополнительные сообщения до окончания всего вычисления.  Это может уменьшить скорость ответа приложения.  Однако можно уменьшить значение этой проблемы, удалив вычисления из потока пользовательского интерфейса.  
  
 \[[Наверх](#top)\]  
  
##  <a name="removing-work"></a> Удаление вычислений из потока пользовательского интерфейса  
 В этом разделе показано, как удалить вычисления по отрисовке из потока пользовательского интерфейса приложения "Мандельброт"  В результате перемещения вычислений по отрисовке из потока пользовательского интерфейса в рабочий поток, поток пользовательского интерфейса получает возможность обрабатывать сообщения, в то время как рабочий поток создает изображение в фоновом режиме.  
  
 Среда выполнения с параллелизмом предоставляет три способа запуска задач: [группы задач](../../parallel/concrt/task-parallelism-concurrency-runtime.md), [асинхронные агенты](../../parallel/concrt/asynchronous-agents.md) и [упрощенные задачи](../../parallel/concrt/task-scheduler-concurrency-runtime.md).  Несмотря на то, что для удаления работы из потока пользовательского интерфейса можно использовать любой из этих механизмов, в данном примере используется объект [Concurrency::task\_group](../Topic/task_group%20Class.md), поскольку группы задач поддерживают отмену.  Позже в данном пошаговом руководстве отмена будет использоваться для уменьшения количества вычислений, производимых при изменении размера окна, и для выполнения очистки при уничтожении окна.  
  
 Также в этом примере используется объект [Concurrency::unbounded\_buffer](../Topic/unbounded_buffer%20Class.md) для обеспечения связи между потоком пользовательского интерфейса и рабочим потоком.  После того, как рабочий поток сгенерировал изображение, он посылает указатель на объект `Bitmap` объекту `unbounded_buffer`, а затем отправляет сообщение изображения в поток пользовательского интерфейса.  Поток пользовательского интерфейса получает от объекта `unbounded_buffer` объект `Bitmap` и отрисовывает его в клиентском окне.  
  
#### Удаление вычислений по отрисовке из потока пользовательского интерфейса  
  
1.  Добавьте в файл stdafx.h следующие директивы `#include`.  
  
     [!code-cpp[concrt-mandelbrot#101](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_9.h)]  
  
2.  В файле ChildView.h добавьте переменные\-члены `task_group` and `unbounded_buffer` в раздел `protected` класса `CChildView`.  Объект `task_group` содержит задачи, выполняющие отрисовку; объект `unbounded_buffer` содержит готовое изображение фрактала Мандельброта.  
  
     [!code-cpp[concrt-mandelbrot#102](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_10.h)]  
  
3.  В файле ChildView.cpp добавьте директиву `using` в пространство имен `concurrency`.  
  
     [!code-cpp[concrt-mandelbrot#103](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_11.cpp)]  
  
4.  В методе `CChildView::DrawMandelbrot`, после вызова метода `Bitmap::UnlockBits`, вызовите функцию [Concurrency::send](../Topic/send%20Function.md) для передачи объекта `Bitmap` в поток пользовательского интерфейса.  Затем отправьте сообщение изображения в поток пользовательского интерфейса и удалите клиентскую область.  
  
     [!code-cpp[concrt-mandelbrot#104](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_12.cpp)]  
  
5.  Обновите метод `CChildView::OnPaint` для получения обновленного объекта `Bitmap` и отобразите изображение в клиентском окне.  
  
     [!code-cpp[concrt-mandelbrot#105](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_13.cpp)]  
  
     Метод `CChildView::OnPaint` создает задачу по созданию изображения фрактала Мандельброта, если его нет в буфере сообщений.  Буфер сообщений не содержит объект `Bitmap` в случае, например, когда сообщение изображения является первым или другое окно выведено поверх клиентского окна.  
  
6.  Убедитесь, что приложение было успешно обновлено, выполнив его построение и запуск.  
  
 Теперь время отклика пользовательского интерфейса уменьшилось, поскольку вычисления по отрисовке выполняются в фоновом режиме.  
  
 \[[Наверх](#top)\]  
  
##  <a name="performance"></a> Повышение производительности отрисовки  
 Отрисовка фрактала Мандельброта — является хороший кандидат для параллелизации, поскольку вычисление каждого пикселя не зависит от других вычислений.  Для параллелизации процесса отрисовки, преобразуйте внешний цикл `for` в метод `CChildView::DrawMandelbrot`, вызывающий параллельный алгоритм [Concurrency::parallel\_for](../Topic/parallel_for%20Function.md), как показано ниже.  
  
 [!code-cpp[concrt-mandelbrot#301](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_14.cpp)]  
  
 Поскольку вычисления каждого элемента растрового изображения не зависят друг от друга, синхронизировать операции по отрисовке, обращающиеся к памяти, в которой хранится растровое изображение, не нужно.  Это улучшает производительность пропорционально увеличению количества доступных процессоров.  
  
 \[[Наверх](#top)\]  
  
##  <a name="cancellation"></a> Добавление поддержки отмены  
 Этот раздел описывает обработку изменения размера окна и процедуру отмены любой активной задачи по отрисовке при уничтожении окна.  
  
 Документ [Отмена](../../parallel/concrt/cancellation-in-the-ppl.md) объясняет, как работает отмена в среде выполнения.  Отмена выполняется совместно, следовательно, не может выполняться мгновенно.  Для остановки отмененной задачи среда выполнения порождает исключение в ходе последующего вызова из задачи в среду выполнения.  В предыдущем разделе показано, как использовать алгоритм `parallel_for` для повышения производительности задачи по отрисовке изображения.  Вызов объекта `parallel_for` позволяет среде выполнения остановить задачу, тем самым позволяя выполняться отмене.  
  
### Отмена активных задач  
 Приложение "Мандельброт" создает объекты `Bitmap`, размер которых совпадает с размером клиентского окна.  Каждый раз, когда клиентское окно изменяет размер, приложение создает фоновую задачу создания изображения для нового размера окна.  Приложению не требуются промежуточные изображения; только изображение конечного размера окна.  Чтобы предотвратить выполнение дополнительной работы приложением, можно отменить любые активные задачи по отрисовке в обработчике сообщений для сообщений `WM_SIZE` и `WM_SIZING`, а затем запланировать задачу заново, когда размер окна будет изменен.  
  
 Для отмены активных задач при изменении размера окна приложение вызывает метод [Concurrency::task\_group::cancel](../Topic/task_group::cancel%20Method.md) обработчика для сообщений `WM_SIZING` и `WM_SIZE`.  Обработчик для сообщения `WM_SIZE` также вызывает метод [Concurrency::task\_group::wait](../Topic/task_group::wait%20Method.md), который ожидает завершения всех активных задач, а затем планирует новую задачу отрисовки для обновленного размера окна.  
  
 Хорошей практикой является отмена любых активных задач по отрисовке после уничтожения клиентского окна.  Отмена любых активных задач по отрисовке позволяет быть уверенным, что рабочий поток не будет отсылать сообщения в поток пользовательского интерфейса после уничтожения клиентского окна.  Приложение отменяет любые активные задачи по отрисовке в обработчике сообщения `WM_DESTROY`.  
  
### Реакция на отмену  
 Метод `CChildView::DrawMandelbrot`, выполняющий задачу по отрисовке, должен отреагировать на отмену.  Поскольку среда выполнения использует обработку исключений для отмены задач, метод `CChildView::DrawMandelbrot` должен использовать механизм, безопасный для исключений, чтобы гарантировать корректную очистку всех ресурсов.  Данный пример использует шаблон *Получение ресурса есть инициализация* \(RAII\), чтобы гарантировать, что после отмены задачи все биты растрового изображения будут разблокированы.  
  
##### Добавление поддержки отмены в приложение "Мандельброт"  
  
1.  В файле ChildView.h в раздел `protected` класса `CChildView` добавьте объявления для функций `OnSize`, `OnSizing` и `OnDestroy` схемы сообщений.  
  
     [!code-cpp[concrt-mandelbrot#201](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_15.h)]  
  
2.  Измените схему сообщения в файле ChildView.cpp так, чтобы она содержала обработчики сообщений `WM_SIZE`, `WM_SIZING`, и `WM_DESTROY`.  
  
     [!code-cpp[concrt-mandelbrot#202](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_16.cpp)]  
  
3.  Реализуйте метод `CChildView::OnSizing`.  Этот метод отменяет любые существующие задачи по отрисовке.  
  
     [!code-cpp[concrt-mandelbrot#203](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_17.cpp)]  
  
4.  Реализуйте метод `CChildView::OnSize`.  Этот метод отменяет любые существующие задачи по отрисовке и создает новую задачу по отрисовке для клиентского окна обновленного размера.  
  
     [!code-cpp[concrt-mandelbrot#204](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_18.cpp)]  
  
5.  Реализуйте метод `CChildView::OnDestroy`.  Этот метод отменяет любые существующие задачи по отрисовке.  
  
     [!code-cpp[concrt-mandelbrot#205](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_19.cpp)]  
  
6.  Определите в файле ChildView.cpp класс `scope_guard`, реализующий шаблон RAII.  
  
     [!code-cpp[concrt-mandelbrot#206](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_20.cpp)]  
  
7.  Добавьте следующий код в метод `CChildView::DrawMandelbrot` после вызова метода `Bitmap::LockBits`:  
  
     [!code-cpp[concrt-mandelbrot#207](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_21.cpp)]  
  
     Этот код обрабатывает отмену, создавая объект `scope_guard`.  Когда объект покидает область, он разблокирует биты растрового изображения.  
  
8.  Измените окончание метода `CChildView::DrawMandelbrot` для удаления объекта `scope_guard` после разблокирования битов растрового изображения, но до отсылки каких\-либо сообщений потоку пользовательского интерфейса.  Это позволяет быть уверенным, что поток интерфейса пользователя не будет обновлен раньше, чем все биты растрового изображения разблокированы..  
  
     [!code-cpp[concrt-mandelbrot#208](../../parallel/concrt/codesnippet/CPP/walkthrough-removing-work-from-a-user-interface-thread_22.cpp)]  
  
9. Убедитесь, что приложение было успешно обновлено, выполнив его построение и запуск.  
  
 При изменении размеров окна вычисления по отрисовке выполняются только для окончательного размера окна.  Любая активная задача по отрисовке отменяется при уничтожении окна.  
  
 \[[Наверх](#top)\]  
  
## См. также  
 [Пошаговые руководства по среде выполнения с параллелизмом](../Topic/Concurrency%20Runtime%20Walkthroughs.md)   
 [Параллелизм задач](../../parallel/concrt/task-parallelism-concurrency-runtime.md)   
 [Асинхронные блоки сообщений](../../parallel/concrt/asynchronous-message-blocks.md)   
 [Функции передачи сообщений](../../parallel/concrt/message-passing-functions.md)   
 [Параллельные алгоритмы](../Topic/Parallel%20Algorithms.md)   
 [Отмена](../../parallel/concrt/cancellation-in-the-ppl.md)   
 [Приложения MFC для рабочего стола](../../mfc/mfc-desktop-applications.md)