---
title: Пролог и эпилог | Документы Microsoft
ms.custom: ''
ms.date: 11/04/2016
ms.technology:
- cpp-tools
ms.topic: conceptual
dev_langs:
- C++
ms.assetid: 0453ed1a-3ff1-4bee-9cc2-d6d3d6384984
author: corob-msft
ms.author: corob
ms.workload:
- cplusplus
ms.openlocfilehash: 2939293fe5fbdfd07cb12470790de5b064489d7f
ms.sourcegitcommit: be2a7679c2bd80968204dee03d13ca961eaa31ff
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2018
ms.locfileid: "32372013"
---
# <a name="prolog-and-epilog"></a>Пролог и эпилог
Любой функции, которая выделяет пространство стека, вызывает другие функции, сохраняет защищенные регистры или использует обработку исключений должен иметь вводной части которого адрес ограничения описаны в очистки данных, связанных с записи в таблице соответствующей функции (см. [(X64) обработки исключений](../build/exception-handling-x64.md)). Прологе сохраняет регистров по внутренним адресам при необходимости помещает защищенных регистров в стек аргумента, выделяет фиксированная часть стека для локальных и временных переменных и при необходимости устанавливает указатель фрейма. В связанных данных завершения описывается действие пролога и необходимо предоставить сведения, необходимые для отмены результатов выполнения кода пролога.  
  
 Если фиксированного выделения стека является более одной страницы (то есть более 4096 байт), возможно, что выделение стека может занимать несколько страниц виртуальной памяти и, таким образом, необходимо выбрать выделение прежде, чем фактически выделяется. Для этой цели предоставляется специальной программе из пролога и который не уничтожает регистры аргумента.  
  
 При сохранении защищенных регистров рекомендуется переместить их в стек до выделения фиксированной части стека. Если выделение фиксированной части стека выполняется до неизменяемые регистры были сохранены, то наиболее вероятно, 32-разрядное смещение будет для обращения к области сохраненного регистра (сообщается, Push-уведомлений регистров работают так же быстро, как перемещается и могут остаться так обозримом будущем всегда неявную зависимость между Push-уведомлений). Неизменяемые регистры можно сохранить в любом порядке. Однако первого использования защищенный регистр в прологе необходимо сохранить его.  
  
 Возможно, код обычно пролога:  
  
```  
mov       [RSP + 8], RCX  
push   R15  
push   R14  
push   R13  
sub      RSP, fixed-allocation-size  
lea      R13, 128[RSP]  
...  
```  
  
 В этом прологе аргумент регистра RCX внутреннему адресу, сохраняются защищенные регистры R13-R15, выделяет фиксированной части кадра стека, а также устанавливает указатель кадра, который указывает 128 байт в фиксированную область. Благодаря использованию смещения обеспечивается более фиксированную область с помощью однобайтовых смещений.  
  
 Если размер фиксированного выделения не меньше одной страницы памяти, вспомогательной функции должен вызываться перед изменением RSP. Этого вспомогательного объекта __chkstk, отвечает за проверку стека в подлежащей выделению диапазона, чтобы правильно расширена стека. В этом случае приведенный выше пример пролога будет выглядеть:  
  
```  
mov       [RSP + 8], RCX  
push   R15  
push   R14  
push   R13  
mov      RAX,  fixed-allocation-size  
call   __chkstk  
sub      RSP, RAX  
lea      R13, 128[RSP]  
...  
```  
  
 Вспомогательная функция __chkstk будет не изменяет только регистры R10, R11 и условных кодов. В частности он вернет RAX без изменений и оставить все неизменяемые регистры и передачи аргументов регистры без изменений.  
  
 Код эпилога существует для каждого выхода в функции. Хотя один пролог, допускается использование нескольких эпилогов. Код эпилога выполняется усечение стека до размера фиксированного выделения (при необходимости), освобождает выделение фиксированной части стека, неизменяемые регистры для восстановления путем извлечения их сохраненных значений из стека и возвращает.  
  
 Код эпилога необходимо выполнить строгому набору правил для очистки кода для очистки надежно исключений и прерываний. Это уменьшает объем используемых данных завершения, так как нет дополнительные данные, необходимые для описания каждого эпилога. Вместо этого код очистки можно определить, что эпилога выполняется посредством прямого просмотра потока кода для идентификации эпилога.  
  
 Если указателя кадра не используется в функции, а затем эпилога необходимо сначала отменить фиксированная часть стека извлекаются неизменяемые регистры и возврата управления вызывающей функции. Например, примененная к объекту директива  
  
```  
add      RSP, fixed-allocation-size  
pop      R13  
pop      R14  
pop      R15  
ret  
```  
  
 Если в функции используется указатель кадра, стека необходимо усечь его фиксированного выделения, перед выполнением эпилога. Это технически не является частью эпилога. Например следующий эпилог может использоваться для отмены ранее выполненного пролога:  
  
```  
lea      RSP, -128[R13]  
; epilogue proper starts here  
add      RSP, fixed-allocation-size  
pop      R13  
pop      R14  
pop      R15  
ret  
```  
  
 На практике Если используется указатель кадра, нет смысла выполнять изменение регистра RSP в два этапа, поэтому вместо него будет использоваться следующий эпилог:  
  
```  
lea      RSP, fixed-allocation-size - 128[R13]  
pop      R13  
pop      R14  
pop      R15  
ret  
```  
  
 Это единственно допустимые формы эпилога. Имя должно содержать либо `add RSP,constant` или `lea RSP,constant[FPReg]`, а затем ряд ноль или более точек POP регистра размером 8 байт и возврата или переход. (Только подмножество безусловный инструкции, допустимые в эпилоге. Это исключительно из операторы jmp со ссылками на память ModRM равно где поля mod ModRM равно значение 00. Использование операторов jmp в эпилоге значение поля mod ModRM равно 01 или 10 запрещено. A-15 см. таблицу в 3 тома Руководство программиста AMD x86 64 архитектура: общего назначения и инструкции по системы, Дополнительные сведения о допустимых ссылках ModRM.). Никакой другой код может использоваться. В частности ничего не может быть запланировано в заключительной части, включая загрузку возвращаемое значение.  
  
 Обратите внимание, что, когда указатель фрейма не используется, необходимо использовать эпилога `add RSP,constant` для отмены выделения фиксированной части стека. Она может не использовать `lea RSP,constant[RSP]` вместо него. Это ограничение существует, поэтому код очистки имеет меньшее число шаблонов, распознаваемых при поиске эпилогов.  
  
 Следующих правил позволяет очистки и код, чтобы определить, что эпилога выполняется в данный момент для имитации выполнение оставшейся части эпилога, что позволяет воссоздать контекст вызывающей функции.  
  
## <a name="see-also"></a>См. также  
 [Программные соглашения для X64](../build/x64-software-conventions.md)