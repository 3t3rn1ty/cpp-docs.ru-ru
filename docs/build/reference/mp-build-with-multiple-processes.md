---
title: "-MP (построить с использованием нескольких процессов) | Microsoft Docs"
ms.custom: ""
ms.date: "12/15/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-cpp"
ms.tgt_pltfrm: ""
ms.topic: "article"
f1_keywords: 
  - "VC.Project.VCCLCompilerTool.MultiProcessorCompilation"
dev_langs: 
  - "C++"
helpviewer_keywords: 
  - "-MP - параметр компилятора (C++)"
  - "/MP - параметр компилятора (C++)"
  - "MP - параметр компилятора (C++)"
  - "компилятор cl.exe, многопроцессорное построение"
ms.assetid: a932b14a-74fe-4b45-84e4-6bf53f0f5e07
caps.latest.revision: 19
caps.handback.revision: 19
author: "corob-msft"
ms.author: "corob"
manager: "ghogen"
---
# /MP (Построить с несколькими процессами)
[!INCLUDE[vs2017banner](../../assembler/inline/includes/vs2017banner.md)]

Параметр **\/MP** позволяет сократить общее время на компиляцию исходных файлов в командной строке.**\/MP** предписывает компилятору создавать одну или несколько собственных копий, каждую в отдельном процессе. Затем эти копии одновременно компилируют исходные файлы. Следовательно, общее время на создание исходных файлов значительно сокращается.  
  
## Синтаксис  
  
```  
/MP[processMax]  
```  
  
## Аргументы  
 `processMax`  
 Максимальное количество процессов, которые может создать компилятор \(необязательно\).  
  
 Аргумент `processMax` должен находиться в диапазоне от 1 до 65 536. В противном случае компилятор выдает предупреждающее сообщение `D9014`, игнорирует аргумент `processMax` и предполагает, что максимальное число процессов равно 1.  
  
 Если опустить аргумент `processMax`, компилятор получает число [эффективных процессоров](#effective_processors) от операционной системы на вашем компьютере и создает процесс для каждого процессора.  
  
## Заметки  
 Параметр компилятора **\/MP** может значительно сократить время построения при компиляции большого числа файлов. Для этого компилятор создает собственные копии \(до `processMax`\), а затем использует их для одновременной компиляции исходных файлов. Параметр **\/MP** применим к компиляциям, но не используется для связывания или создания кода во время компоновки. По умолчанию параметр **\/MP** отключен.  
  
 Улучшение в построении зависит от числа процессоров на компьютере, количества компилируемых файлов и доступности системных ресурсов, таких как емкость ввода\-вывода. Поэкспериментируйте с параметром **\/MP**, чтобы определить оптимальные настройки для построения конкретного проекта. Советы в разделе [Рекомендации](#guidelines) помогут вам принять правильное решение.  
  
## Несовместимые параметры и языковые компоненты  
 Параметр **\/MP** не совместим с некоторыми параметрами компилятора и языковыми компонентами. При использовании несовместимого параметра компилятора с параметром **\/MP** компилятор выдает предупреждение `D9030` и игнорирует параметр **\/MP**. При использовании несовместимого языкового компонента компилятор выдает ошибку `C2813`, а затем завершает или продолжает работу в зависимости от текущего порога предупреждений компилятора.  
  
> [!NOTE]
>  Большинство параметров являются несовместимыми, так как если бы они были разрешены, параллельно выполняющиеся компиляторы одновременно записывали бы свои выходные данные в консоль или в конкретный файл. В результате произошло бы смешивание и искажение выходных данных. В некоторых случаях сочетание параметров может снизить производительность.  
  
 В следующей таблице перечислены параметры компилятора и языковые компоненты, несовместимые с параметром **\/MP**.  
  
|Параметр или языковой компонент|Описание|  
|-------------------------------------|--------------|  
|Директива препроцессора [\#import](../Topic/%23import%20Directive%20\(C++\).md)|Преобразует типы библиотеки типов в классы C\+\+, а затем записывает эти классы в файл заголовка.|  
|[\/E](../../build/reference/e-preprocess-to-stdout.md), [\/EP](../../build/reference/ep-preprocess-to-stdout-without-hash-line-directives.md)|Копирует выходные данные препроцессора в стандартный поток вывода \(**stdout**\).|  
|[\/Gm](../../build/reference/gm-enable-minimal-rebuild.md)|Включает инкрементную перестройку.|  
|[\/showIncludes](../Topic/-showIncludes%20\(List%20Include%20Files\).md)|Записывает список включаемых файлов в стандартную ошибку \(**stderr**\).|  
|[\/Yc](../../build/reference/yc-create-precompiled-header-file.md)|Создает файл предкомпилированного заголовка.|  
  
## Диагностические сообщения  
 При указании параметра или языкового компонента, несовместимого с параметром **\/MP**, вы получите соответствующее диагностическое сообщение. В следующей таблице перечислены возможные сообщения и поведение компилятора:  
  
|Диагностическое сообщение|Описание|Поведение компилятора|  
|-------------------------------|--------------|---------------------------|  
|`C2813`|Директива **\#import** не совместима с параметром **\/MP**.|Компиляция заканчивается, если для параметра [Порог предупреждений компилятора](../../build/reference/compiler-option-warning-level.md) не указано иное.|  
|`D9014`|Указано недопустимое значение для аргумента `processMax`.|Компилятор игнорирует недопустимое значение и принимает значение равным 1.|  
|`D9030`|Указанный параметр не совместим с **\/MP**.|Компилятор игнорирует параметр **\/MP**.|  
  
##  <a name="guidelines"></a> Рекомендации  
  
### Измерение производительности  
 Для измерения производительности используется общее время построения. Его можно измерить с помощью обычных часов или программного обеспечения, которое вычисляет разницу между началом и завершением построения. Если компьютер оснащен несколькими процессорами, физические часы могут дать более точные результаты, чем измерение времени с помощью программного обеспечения.  
  
###  <a name="effective_processors"></a> Эффективные процессоры  
 Для каждого физического процессора в компьютере может существовать один или несколько виртуальных процессоров, которые также называются эффективными. Каждый физический процессор может состоять из одного или нескольких ядер, а при использовании технологии Hyper\-Threading каждое ядро определяется операционной системой как два отдельных виртуальных процессора.  
  
 Например, компьютер имеет один эффективный процессор, если он оснащен одним физическим процессором с одним ядром и отключенной технологией Hyper\-Threading. Другой вариант: компьютер имеет восемь эффективных процессоров, если он оснащен двумя физическими процессорами, каждый из которых имеет два ядра, и для всех ядер включена технология Hyper\-Threading. То есть \(8 эффективных процессоров\) \= \(2 физических процессора\) x \(2 ядра на физический процессор\) x \(2 эффективных процессора на ядро благодаря Hyper\-Threading\).  
  
 Если опустить аргумент `processMax` в параметре **\/MP**, компилятор получает число эффективных процессоров от операционной системы и создает по одному процессу на каждый эффективный процессор. Тем не менее, компилятор не может гарантировать, что отдельно взятый процесс будет выполняться на конкретном процессоре; это решение принимает операционная система.  
  
### Число процессов  
 Компилятор вычисляет число процессов, которые будут использоваться для компиляции исходных файлов. При этом выбирается меньшее значение из количества исходных файлов, указанных в командной строке, и числа процессов, явно или неявно указанных в параметре **\/MP**. Вы можете явным образом задать максимальное число процессов, если укажете аргумент `processMax` параметра **\/MP**. Можно также использовать значение по умолчанию, равное числу эффективных процессоров в компьютере, если не указан аргумент `processMax`.  
  
 Например, можно ввести следующее в командной строке:  
  
 `cl /MP7 a.cpp b.cpp c.cpp d.cpp e.cpp`  
  
 В этом случае компилятор использует пять процессов, поскольку это меньшее значение из числа исходных файлов \(пять\) и максимального количества процессов \(семь\). Теперь предположим, что компьютер имеет два эффективных процессора и вы ввели следующую команду в командной строке:  
  
 `cl /MP a.cpp b.cpp c.cpp`  
  
 В этом случае операционная система сообщает о двух процессорах, поэтому компилятор использует два процесса в своих вычислениях. В результате компилятор произведет построение с использованием двух процессов, поскольку это меньшее число из двух процессов и трех исходных файлов.  
  
### Исходные файлы и порядок построения  
 Исходные файлы могут компилироваться не в том порядке, в котором они появляются в командной строке. Хотя компилятор создает набор процессов, содержащий копии компилятора, операционная система все равно планирует время выполнения каждого процесса. Следовательно, вы не можете гарантировать, что исходные файлы будут компилироваться в определенном порядке.  
  
 Исходный файл компилируется, когда доступен процесс для его компиляции. Если число файлов превышает число процессов, первый набор файлов компилируется свободными процессами. Оставшиеся файлы обрабатываются тогда, когда процесс завершает обработку предыдущих файлов и доступен для работы на одном из остальных файлов.  
  
 Не указывайте один и тот же исходный файл в командной строке несколько раз. Это может произойти, например, если инструмент автоматически создает файл [makefile](../../build/contents-of-a-makefile.md), основанный на данных о зависимостях в проекте. Если параметр **\/MP** не указан, компилятор последовательно обрабатывает список файлов и повторно компилирует каждое вхождение файла. Тем не менее, если указать параметр **\/MP**, разные компиляторы могут одновременно скомпилировать один и тот же файл. Таким образом, разные компиляторы попытаются одновременно выполнить запись в один и тот же выходной файл. Один из компиляторов получит монопольный доступ на запись в выходной файл и успешно выполнит ее, а работа остальных компиляторов завершится из\-за ошибки доступа к файлу.  
  
### Использование библиотек типов \(\#import\)  
 Компилятор не поддерживает использование директивы [\#import](../Topic/%23import%20Directive%20\(C++\).md) с параметром **\/MP**. Если возможно, выполните следующие действия, чтобы устранить проблему.  
  
-   Переместите все директивы `#import` из различных исходных файлов в один или несколько файлов, затем скомпилируйте эти файлы без параметра **\/MP**. Результатом является набор файлов заголовка.  
  
-   В оставшихся исходных файлах вставьте директивы [\#include](../../preprocessor/hash-include-directive-c-cpp.md), определяющие созданные заголовки, и скомпилируйте эти исходные файлы с помощью параметра **\/MP**.  
  
### Параметры проекта Visual Studio  
  
#### Инструмент MSBUILD.exe  
 [!INCLUDE[vsprvs](../../assembler/masm/includes/vsprvs_md.md)] использует инструмент [MSBuild.exe](../Topic/MSBuild%20Reference.md) для создания решений и проектов. Параметр командной строки **\/maxcpucount:**`number` \(или **\/m:**`number`\) инструмента MSBuild.exe позволяет создать несколько проектов одновременно. С помощью параметра компилятора **\/MP** можно одновременно построить несколько блоков компиляции. Если это требуется для вашего приложения, сократите время построения решения с помощью одного или обоих параметров **\/MP** и **\/maxcpucount**.  
  
 Время построения решения отчасти зависит от числа процессов, выполняющих построение. Аргумент `number` параметра [\/maxcpucount](../Topic/MSBuild%20Command-Line%20Reference.md) в MSBuild определяет максимальное число проектов для одновременного построения. Аналогичным образом аргумент `processMax` параметра компилятора **\/MP** указывает максимальное количество единиц компиляции для одновременного построения. Если в параметре **\/maxcpucount** указано *P* проектов, а в параметре **\/MP** — *C* процессов, одновременно выполняется максимум *P*x*C* процессов.  
  
 Рекомендации для принятия решения об использовании `MSBuild` или технологии **\/MP** выглядят так:  
  
-   При наличии большого числа проектов, каждый из которых содержит несколько файлов, используйте `MSBuild`.  
  
-   При наличии нескольких проектов, каждый из которых содержит большое количество файлов, используйте параметр **\/MP**.  
  
-   Если число проектов и файлов в каждом проекте соразмерно, используйте как `MSBuild`, так и **\/MP**. Изначально параметр **\/maxcpucount** задается равным числу проектов для построения, а параметр **\/MP** — числу процессоров на компьютере. Измерьте производительность и произведите настройку, чтобы добиться наилучших результатов. Повторите цикл, пока не будет достигнуто оптимальное общее время построения.  
  
#### Параметр компилятора \/Gm  
 По умолчанию построение проекта включает параметр компилятора **\/Gm** \(инкрементное построение\) для отладочных построений и отключает его для построения выпуска. Таким образом, параметр компилятора **\/MP** автоматически отключается в отладочных построениях, так как он конфликтует со значением по умолчанию параметра компилятора **\/Gm**.  
  
## См. также  
 [Директива \#import](../Topic/%23import%20Directive%20\(C++\).md)   
 [Справочник по командной строке](../Topic/MSBuild%20Command-Line%20Reference.md)