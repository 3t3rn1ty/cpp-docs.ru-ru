---
title: "Пошаговое руководство. Использование отладчика с асинхронными методами | Microsoft Docs"
ms.custom: ""
ms.date: "11/17/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-csharp"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "FSharp"
  - "VB"
  - "CSharp"
  - "C++"
helpviewer_keywords: 
  - "функция async, использование отладчика"
  - "оператор await, использование отладчика"
  - "Шаг с заходом - команда, в операторе await"
  - "Шаг с выходом - команда, в методе async"
  - "Шаг с обходом - команда, в операторе await"
ms.assetid: 5adb2531-3f09-4b7e-8baa-29de80abee6e
caps.latest.revision: 23
caps.handback.revision: 23
author: "rpetrusha"
ms.author: "ronpet"
manager: "wpickett"
---
# Пошаговое руководство. Использование отладчика с асинхронными методами
С помощью функции Async можно вызывать асинхронные методы, не прибегая к использованию обратных вызовов или разделению кода между несколькими методами или лямбда\-выражениями.  Чтобы сделать синхронный код асинхронным, следует вызвать асинхронный метод вместо синхронного и добавить в код несколько ключевых слов.  Дополнительные сведения см. в разделе [Асинхронное программирование с использованием ключевых слов Async и Await](../Topic/Asynchronous%20Programming%20with%20Async%20and%20Await%20\(C%23%20and%20Visual%20Basic\).md).  
  
 В отладчике Visual Studio можно использовать команды **Шаг с заходом**, **Шаг с обходом** и **Шаг с выходом** с функцией `Async`.  Также можно продолжать использовать точки останова, в частности для отслеживания потока управления в коде, содержащем оператор await.  В этом пошаговом руководстве будут выполнены следующие задачи, которые можно выполнять в любом порядке.  
  
-   Наблюдение за потоком управления в операторе await с помощью точек останова.  
  
-   Изучение поведения команд **Шаг с заходом** и **Шаг с обходом** в операторах, содержащих оператор await.  
  
-   Изучение поведения команды **Шаг с выходом** при ее использовании внутри асинхронного метода.  
  
## Отслеживание потока управления с помощью точек останова  
 Если в объявлении метода указать модификатор [Async](../Topic/Async%20\(Visual%20Basic\).md) \(Visual Basic\) или [async](../Topic/async%20\(C%23%20Reference\).md) \(C\#\), то в этом методе можно использовать оператор [Await](../Topic/Async%20\(Visual%20Basic\).md) \(Visual Basic\) или [await](../Topic/await%20\(C%23%20Reference\).md) \(C\#\).  Выражение await связывает оператор await с задачей.  При вызове выражения await для этой задачи текущий метод сразу же перестает выполняться и возвращает другую задачу.  После завершения выполнения задачи, связанной с оператором await, возобновляется выполнение прерванного метода \(вызвавшего выражение await\).  Дополнительные сведения см. в разделе [Поток управления в асинхронных программах](../Topic/Control%20Flow%20in%20Async%20Programs%20\(C%23%20and%20Visual%20Basic\).md).  
  
> [!NOTE]
>  Асинхронный метод возвращает управление вызвавшему его объекту, когда он встречает первый ожидаемый объект, выполнение которого еще не завершено, или когда он доходит до конца синхронного метода — в зависимости от того, что происходит раньше.  
  
> [!NOTE]
>  В консольных приложениях в данных примерах используется метод <xref:System.Threading.Tasks.Task.Wait%2A> для предотвращения завершения работы приложения в методе `Main`.  Не следует использовать метод <xref:System.Threading.Tasks.Task.Wait%2A> вне консольных приложений, так как это может привести к возникновению взаимоблокировки.  
  
 Ниже приведена процедура использования точек останова для изучения работы приложения при достижении им оператора await.  Для контроля потока выполнения также можно добавить в программу операторы `Debug.WriteLine`.  
  
1.  Создайте консольное приложение и вставьте в него следующий код:  
  
     [!code-cs[csAsyncDebugging#1](../misc/codesnippet/CSharp/walkthrough-using-the-debugger-with-async-methods_1.cs)]
     [!code-vb[csAsyncDebugging#1](../misc/codesnippet/VisualBasic/walkthrough-using-the-debugger-with-async-methods_1.vb)]  
  
2.  Установите отладочные точки останова в трех строках, оканчивающихся комментарием "установить точку останова" \("set breakpoint"\).  
  
3.  Нажмите клавишу F5 или в строке меню выберите **Отладка**, **Начать отладку**, чтобы запустить приложение.  
  
     Выполнение приложения доходит до метода `ProcessAsync` и приостанавливается внутри этого метода на строке с оператором await.  
  
4.  Снова нажмите клавишу F5.  
  
     Так как выполнение приложения было остановлено на строке, содержащей выражение await, приложение немедленно выходит из асинхронного метода, при этом метод возвращает задачу.  Следовательно, приложение выходит из метода `ProcessAsync`, после чего выполнение приостанавливается в точке останова внутри вызывающего метода \(`Main`\).  
  
5.  Снова нажмите клавишу F5.  
  
     После завершения выполнения метода `DoSomethingAsync` возобновляется выполнение кода, следующего за оператором await в вызывающем методе.  Поэтому выполнение приложения приостанавливается в точке останова внутри метода `ProcessAsync`.  
  
     Ранее, инициировав ожидание результата выполнения метода `DoSomethingAsync`, метод `ProcessAsync` передал управление вызвавшему его методу и вернул задачу.  Теперь метод `DoSomethingAsync` завершил свою работу, а возвращенный им результат выполнения передан оператору await метода `DoSomethingAsync`.  В объявлении метода `DoSomethingAsync` указано, что он возвращает `Task (Of Integer)` \(в Visual Basic\) или `Task<int>` \(в C\#\), поэтому его оператор return возвращает целое число.  Дополнительные сведения см. в разделе [Асинхронные типы возвращаемых значений](../Topic/Async%20Return%20Types%20\(C%23%20and%20Visual%20Basic\).md).  
  
### Получение задачи и ожидание ее выполнения  
 Оператор `Dim result = Await DoSomethingAsync()` \(Visual Basic\) или `var result = await DoSomethingAsync();` \(C\#\) в методе `ProcessAsync` представляет собой сокращенную форму записи двух следующих операторов:  
  
 [!code-cs[csAsyncDebugging#2](../misc/codesnippet/CSharp/walkthrough-using-the-debugger-with-async-methods_2.cs)]
 [!code-vb[csAsyncDebugging#2](../misc/codesnippet/VisualBasic/walkthrough-using-the-debugger-with-async-methods_2.vb)]  
  
 Первая строка кода вызывает асинхронный метод и возвращает задачу.  Следующая строка кода связывает эту задачу с оператором await.  Оператор await производит выход из текущего метода \(`ProcessAsync`\) и возвращает другую задачу.  После того как завершается выполнение задачи, связанной с оператором await, выполнение прерванного метода \(`ProcessAsync`\) возобновляется с кода, расположенного после оператора await.  
  
 Непосредственно в тот момент, когда оператор await возвращает другую задачу, эта задача представляет возвращаемый аргумент асинхронного метода, содержащего оператор await \(то есть метода `ProcessAsync`\).  Задача, возвращаемая оператором await, включает выполнение кода, расположенного после оператора await в этом же методе, поэтому она отличается от задачи, связанной с оператором await.  
  
## Шаг с заходом и шаг с обходом  
 Команда **Шаг с заходом** заходит внутрь метода, тогда как команда **Шаг с обходом** выполняет вызов метода и останавливает выполнение на следующей строке вызывающего метода.  Дополнительные сведения см. в [Выполнение шагов с заходом в код, с обходом кода или выходом из него](../Topic/Navigating%20through%20Code%20with%20the%20Debugger.md#BKMK_Step_into__over__or_out_of_the_code).  
  
 В следующей процедуре показано, что происходит при выборе команды **Шаг с заходом** или **Шаг с обходом** на строке с оператором await.  
  
1.  Замените код в консольном приложении следующим кодом:  
  
     [!code-cs[csAsyncDebugging#3](../misc/codesnippet/CSharp/walkthrough-using-the-debugger-with-async-methods_3.cs)]
     [!code-vb[csAsyncDebugging#3](../misc/codesnippet/VisualBasic/walkthrough-using-the-debugger-with-async-methods_3.vb)]  
  
2.  Нажмите клавишу F11 или в строке меню выберите **Отладка**, **Шаг с заходом**, чтобы начать демонстрацию работы команды `Step Into` в отношении оператора, содержащего выражение await.  
  
     Приложение начинает выполняться и останавливается на первой строке, а именно на строке `Sub Main()` \(в Visual Basic\) или на строке с открывающей фигурной скобкой метода `Main` \(в C\#\).  
  
3.  Нажмите клавишу F11 еще три раза.  
  
     Теперь приложение должно находиться на операторе await внутри метода `ProcessAsync`.  
  
4.  Нажмите клавишу F11.  
  
     Приложение заходит в метод `DoSomethingAsync` и останавливается на первой строке.  Команда "Шаг с заходом" работает таким образом несмотря на то, что при выполнении оператора `await` приложение немедленно возвращается в вызывающий метод \(`Main`\).  
  
5.  Многократно нажимайте клавишу F11 до тех пор, пока приложение не вернется к оператору await метода `ProcessAsync`.  
  
6.  Нажмите клавишу F11.  
  
     Выполнение приложения приостанавливается на строке, следующей за оператором await.  
  
7.  В строке меню выберите **Отладка**, **Остановить отладку**, чтобы остановить выполнение приложения.  
  
     В следующей части процедуры демонстрируется работа команды **Шаг с обходом** в отношении оператора await.  
  
8.  Нажмите четыре раза клавишу F11 или четыре раза выберите **Отладка**, **Шаг с заходом** в строке меню.  
  
     Теперь приложение должно находиться на операторе await внутри метода `ProcessAsync`.  
  
9. Нажмите клавишу F10 или в строке меню выберите **Отладка**, **Шаг с обходом**.  
  
     Выполнение приложения приостанавливается на строке, которая следует за оператором await.  Команда "Шаг с обходом" работает таким образом несмотря на то, что при выполнении оператора await приложение немедленно возвращается в вызывающий метод \(`Main`\).  При этом, как и ожидалось, команда `Step Over` обходит пошаговое выполнение метода `DoSomethingAsync`.  
  
10. В строке меню выберите **Отладка**, **Остановить отладку**, чтобы остановить выполнение приложения.  
  
     Как будет показано в следующих шагах, поведение команд **Шаг с заходом** и **Шаг с обходом** слегка отличается в том случае, когда вызов асинхронного метода и оператор await располагаются в разных строках.  
  
11. В методе `ProcessAsync` замените строку с оператором await показанным ниже кодом.  Первоначальная строка с оператором await является сокращенной формой записи двух следующих строк.  
  
     [!code-cs[csAsyncDebugging#2](../misc/codesnippet/CSharp/walkthrough-using-the-debugger-with-async-methods_2.cs)]
     [!code-vb[csAsyncDebugging#2](../misc/codesnippet/VisualBasic/walkthrough-using-the-debugger-with-async-methods_2.vb)]  
  
12. Несколько раз нажмите клавишу F11 или в строке меню выберите **Отладка**, **Шаг с заходом**, чтобы начать выполнение приложения в пошаговом режиме.  
  
     На строке с вызовом метода `DoSomethingAsync` команда **Шаг с заходом** останавливает выполнение внутри метода `DoSomethingAsync`, тогда как команда **Шаг с обходом**, как и ожидалось, переходит к следующему оператору.  На строке с оператором await обе команды останавливают выполнение на операторе, следующем за оператором await.  
  
## Шаг с выходом  
 При выполнении команды **Шаг с выходом** в синхронном методе выполнение останавливается в вызывающем методе на строке кода, следующей за вызовом метода.  В случае асинхронного метода место остановки выполнения в вызывающем методе определяется более сложным образом и зависит от того, находится ли команда **Шаг с выходом** в первой строке асинхронного метода.  
  
1.  Замените код в консольном приложении следующим кодом:  
  
     [!code-cs[csAsyncDebugging#4](../misc/codesnippet/CSharp/walkthrough-using-the-debugger-with-async-methods_4.cs)]
     [!code-vb[csAsyncDebugging#4](../misc/codesnippet/VisualBasic/walkthrough-using-the-debugger-with-async-methods_4.vb)]  
  
2.  Установите точку останова на строке `Debug.WriteLine("before")` в методе `DoSomethingAsync`.  
  
     Это позволит увидеть, как ведет себя команда **Шаг с выходом** при ее выполнении из строки, не являющейся первой строкой асинхронного кода.  
  
3.  Нажмите клавишу F5 или в строке меню выберите **Отладка**, **Начать отладку**, чтобы начать выполнение приложения.  
  
     Выполнение кода останавливается на строке `Debug.WriteLine("before")` внутри метода `DoSomethingAsync`.  
  
4.  Нажмите клавиши Shift\+F11 или в строке меню выберите **Отладка**, **Шаг с выходом**.  
  
     Приложение останавливается в вызывающем методе на операторе await, который относится к задаче, возвращаемой вызываемым методом.  То есть приложение останавливается на операторе await в методе `ProcessAsync`.  Приложение не останавливается на строке кода `Dim z = 0` \(в Visual Basic\) или `int z = 0;` \(в C\#\), расположенной после вызова метода `DoSomethingAsync`.  
  
5.  В строке меню выберите **Отладка**, **Остановить отладку**, чтобы остановить выполнение приложения.  
  
     В следующей части процедуры будет показано, что происходит, когда команда **Шаг с выходом** выполняется из самой первой строки асинхронного кода.  
  
6.  Удалите существующую точку останова и добавьте точку останова в первую строку метода `DoSomethingAsync`.  
  
     В C\# добавьте точку останова в строку с открывающей фигурной скобкой метода `DoSomethingAsync`.  В Visual Basic добавьте точку останова в строку, которая содержит `Async Function DoSomethingAsync() As Task(Of Integer)`.  
  
7.  Нажмите клавишу F5, чтобы запустить приложение.  
  
     Выполнение кода останавливается на первой строке метода `DoSomethingAsync`.  
  
8.  В строке меню выберите **Отладка**, **Окна**, **Выходные данные**.  
  
     Откроется окно **Выходные данные**.  
  
9. Нажмите клавиши Shift\+F11 или в строке меню выберите **Отладка**, **Шаг с выходом**.  
  
     Выполнение возобновляется и продолжается до тех пор, пока не оказывается достигнут первый оператор await в асинхронном методе, после чего выполнение останавливается на операторе вызова в вызывающем методе.  То есть приложение останавливается на строке `Dim the Task = DoSomethingAsync()` \(в Visual Basic\) или `var theTask = DoSomethingAsync();` \(в C\#\).  При этом в окне вывода появляется сообщение "прежде" \("before"\), а сообщение "после" \("after"\) еще не появляется.  
  
10. Нажмите клавишу F5, чтобы продолжить выполнение приложения.  
  
     Выполнение возобновляется с оператора, расположенного после оператора await в вызываемом асинхронном методе \(`DoSomethingAsync`\).  В окне "Выходные данные" отображается сообщение "после" \("after"\).  
  
## См. также  
 [Навигация по коду с помощью отладчика](../Topic/Navigating%20through%20Code%20with%20the%20Debugger.md)