---
title: "Вопросы, связанные с написанием кода пролога и эпилога | Microsoft Docs"
ms.custom: ""
ms.date: "12/05/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-cpp"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "C++"
  - "C"
helpviewer_keywords: 
  - "__LOCAL_SIZE - константа"
  - "макеты, кадр стека"
  - "макет кадра стека"
  - "стек, макет кадра стека"
ms.assetid: 3b8addec-e809-48e4-b1d0-5bad133bd4b8
caps.latest.revision: 8
caps.handback.revision: 8
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
---
# Вопросы, связанные с написанием кода пролога и эпилога
[!INCLUDE[vs2017banner](../assembler/inline/includes/vs2017banner.md)]

**Блок, относящийся только к системам Microsoft**  
  
 Перед написанием собственных последовательностей кодов пролога и эпилога важно понимать, как размещается кадр стека.  Полезно также знать, как использовать предопределенную константу **\_\_LOCAL\_SIZE**.  
  
##  <a name="_clang_c_stack_frame_layout"></a> Макет кадра стека C  
 В данном примере показан стандартный код пролога, который может присутствовать в 32\-разрядной функции.  
  
```  
push     ebp                 ; Save ebp  
mov      ebp, esp            ; Set stack frame pointer  
sub      esp, localbytes     ; Allocate space for locals  
push     <registers>         ; Save registers  
```  
  
 Переменная `localbytes` представляет число байтов, которые требуются в стеке для локальных переменных, а переменная `registers` — это заполнитель, представляющий список сохраняемых в стеке регистров.  После проталкивания регистров можно разместить в стеке все другие необходимые данные.  Ниже приведен соответствующий код эпилога.  
  
```  
pop      <registers>         ; Restore registers  
mov      esp, ebp            ; Restore stack pointer  
pop      ebp                 ; Restore ebp  
ret                          ; Return from function  
```  
  
 Стек всегда расширяется в направлении вниз \(от старших адресов памяти к младшим\).  Указатель базы \(`ebp`\) указывает на помещенное в стек значение `ebp`.  Область локальных переменных начинается с `ebp-2`.  Для доступа к локальным переменным необходимо вычислить смещение от `ebp` путем вычитания соответствующего значения из `ebp`.  
  
##  <a name="_clang_the___local_size_constant"></a> Константа \_\_LOCAL\_SIZE  
 Компилятор предоставляет константу \(**\_\_LOCAL\_SIZE**\) для использования во встроенном ассемблерном блоке кода пролога функции.  Она служит для выделения пространства локальным переменным в кадре стека пользовательского кода пролога.  
  
 Значение константы **\_\_LOCAL\_SIZE** определяется компилятором.  Это значение представляет общее количество байтов всех определяемых пользователем локальных переменных и временных переменных, создаваемых компилятором.  Константу **\_\_LOCAL\_SIZE** можно использовать только в качестве непосредственного операнда; в выражении ее использовать невозможно.  Значение этой константы не следует изменять и переопределять.  Например:  
  
```  
mov      eax, __LOCAL_SIZE           ;Immediate operand--Okay  
mov      eax, [ebp - __LOCAL_SIZE]   ;Error  
```  
  
 В следующем примере функции с атрибутом naked, содержащей пользовательские последовательности пролога и эпилога, константа **\_\_LOCAL\_SIZE** используется в последовательности пролога.  
  
```  
__declspec ( naked ) func()  
{  
   int i;  
   int j;  
  
   __asm      /* prolog */  
      {  
      push   ebp  
      mov      ebp, esp  
      sub      esp, __LOCAL_SIZE  
      }  
  
   /* Function body */  
  
   __asm      /* epilog */  
      {  
      mov      esp, ebp  
      pop      ebp  
      ret  
      }  
}     
```  
  
 **Завершение блока, относящегося только к системам Microsoft**  
  
## См. также  
 [Функции Naked](../c-language/naked-functions.md)